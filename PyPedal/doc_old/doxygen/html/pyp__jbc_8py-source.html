<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>PyPedal: PyPedal/pyp_jbc.py Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.4.7 -->
<div class="tabs">
  <ul>
    <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
    <li><a href="namespaces.html"><span>Packages</span></a></li>
    <li><a href="classes.html"><span>Classes</span></a></li>
    <li id="current"><a href="files.html"><span>Files</span></a></li>
  </ul></div>
<h1>PyPedal/pyp_jbc.py</h1><div class="fragment"><pre class="fragment"><a name="l00001"></a><a class="code" href="namespacePyPedal_1_1pyp__jbc.html">00001</a> <span class="comment">###############################################################################</span>
<a name="l00002"></a>00002 <span class="comment"># NAME: pyp_jbc.py</span>
<a name="l00003"></a>00003 <span class="comment"># VERSION: 1.0b15 (18SEPTEMBER2006)</span>
<a name="l00004"></a>00004 <span class="comment"># AUTHOR: John B. Cole, PhD (jcole@aipl.arsusda.gov)</span>
<a name="l00005"></a>00005 <span class="comment"># LICENSE: LGPL`</span>
<a name="l00006"></a>00006 <span class="comment">###############################################################################</span>
<a name="l00007"></a>00007 <span class="comment"># FUNCTIONS:</span>
<a name="l00008"></a>00008 <span class="comment">#     get_color_32()</span>
<a name="l00009"></a>00009 <span class="comment">#     color_pedigree()</span>
<a name="l00010"></a>00010 <span class="comment">#     draw_colored_pedigree()</span>
<a name="l00011"></a>00011 <span class="comment">#     new_draw_colored_pedigree()</span>
<a name="l00012"></a>00012 <span class="comment">###############################################################################</span>
<a name="l00013"></a>00013 
<a name="l00014"></a>00014 <span class="comment">## @package pyp_jbc</span>
<a name="l00015"></a>00015 <span class="comment"># pyp_template provides a skeleton on which user-defined modules may be built.</span>
<a name="l00016"></a>00016 <span class="comment">##</span>
<a name="l00017"></a>00017 
<a name="l00018"></a>00018 <span class="keyword">import</span> logging, math, numpy
<a name="l00019"></a>00019 <span class="keyword">from</span> PyPedal <span class="keyword">import</span>  pyp_graphics
<a name="l00020"></a>00020 <span class="keyword">from</span> PyPedal <span class="keyword">import</span> pyp_network
<a name="l00021"></a>00021 <span class="keyword">from</span> PyPedal <span class="keyword">import</span> pyp_utils
<a name="l00022"></a>00022 
<a name="l00023"></a>00023 <span class="comment">##</span>
<a name="l00024"></a>00024 <span class="comment"># get_color_32() Converts a float value to one of a continuous range of colors</span>
<a name="l00025"></a>00025 <span class="comment"># using recipe 9.10 from the Python Cookbook.  Returns 32-bit colors rather than</span>
<a name="l00026"></a>00026 <span class="comment"># 16-bit colors.</span>
<a name="l00027"></a>00027 <span class="comment"># @param a Float value to convert to a color.</span>
<a name="l00028"></a>00028 <span class="comment"># @param cmin Minimum value in array (?).</span>
<a name="l00029"></a>00029 <span class="comment"># @param cmax Maximum value in array (?).</span>
<a name="l00030"></a>00030 <span class="comment"># @retval An RGB triplet.</span>
<a name="l00031"></a><a class="code" href="namespacePyPedal_1_1pyp__jbc.html#684ddf07aa8b4275b4de4025306bb8ac">00031</a> <span class="keyword">def </span><a class="code" href="namespacePyPedal_1_1pyp__jbc.html#684ddf07aa8b4275b4de4025306bb8ac">get_color_32</a>(a, cmin, cmax):
<a name="l00032"></a>00032     <span class="stringliteral">"""</span>
<a name="l00033"></a>00033 <span class="stringliteral">    Convert a float value to one of a continuous range of colors.</span>
<a name="l00034"></a>00034 <span class="stringliteral">    Rewritten to use recipe 9.10 from the O'Reilly Python Cookbook.</span>
<a name="l00035"></a>00035 <span class="stringliteral">    Returns 32-bit colors rather than 16-bit colors.</span>
<a name="l00036"></a>00036 <span class="stringliteral">    """</span>
<a name="l00037"></a>00037     <span class="keywordflow">try</span>:
<a name="l00038"></a>00038         a = float( a - cmin ) / ( cmax - cmin )
<a name="l00039"></a>00039     <span class="keywordflow">except</span> ZeroDivisionError:
<a name="l00040"></a>00040         a = 0.5 <span class="comment"># cmax == cmin</span>
<a name="l00041"></a>00041     blue = min((max((4*(0.75-a),0.)),1.))
<a name="l00042"></a>00042     red = min((max((4*(a-0.25),0.)),1.))
<a name="l00043"></a>00043     green = min((max((4*math.fabs(a-0.5)-1.,0)),1.))
<a name="l00044"></a>00044     _r = <span class="stringliteral">'%2x'</span> % int(255*red)
<a name="l00045"></a>00045     <span class="keywordflow">if</span> _r[0] == <span class="stringliteral">' '</span>:
<a name="l00046"></a>00046         _r = <span class="stringliteral">'0%s'</span> % _r[1]
<a name="l00047"></a>00047     _g = <span class="stringliteral">'%2x'</span> % int(255*green)
<a name="l00048"></a>00048     <span class="keywordflow">if</span> _g[0] == <span class="stringliteral">' '</span>:
<a name="l00049"></a>00049         _g = <span class="stringliteral">'0%s'</span> % _g[1]
<a name="l00050"></a>00050     _b = <span class="stringliteral">'%2x'</span> % int(255*blue)
<a name="l00051"></a>00051     <span class="keywordflow">if</span> _b[0] == <span class="stringliteral">' '</span>:
<a name="l00052"></a>00052         _b = <span class="stringliteral">'0%s'</span> % _b[1]
<a name="l00053"></a>00053     _triple = <span class="stringliteral">'#%s%s%s'</span> % (_r,_g,_b)
<a name="l00054"></a>00054     <span class="keywordflow">return</span> _triple
<a name="l00055"></a>00055 
<a name="l00056"></a>00056 <span class="comment">##</span>
<a name="l00057"></a>00057 <span class="comment"># color_pedigree() forms a graph object from a pedigree object and determines the</span>
<a name="l00058"></a>00058 <span class="comment"># proportion of animals in a pedigree that are descendants of each animal in the</span>
<a name="l00059"></a>00059 <span class="comment"># pedigree. The results will be used to feed draw_colored_pedigree().</span>
<a name="l00060"></a>00060 <span class="comment"># @param pedobj A PyPedal pedigree object.</span>
<a name="l00061"></a>00061 <span class="comment"># @param metric Count for coloring nodes in the pedigree (descendants|sons).</span>
<a name="l00062"></a>00062 <span class="comment"># @param places Number of decimal palces to carry when rounding proportions.</span>
<a name="l00063"></a>00063 <span class="comment"># @param drawer Routine to use for drawing the pedigree (new|old).</span>
<a name="l00064"></a>00064 <span class="comment"># @param **kw Optional keywork arguments passed through to other functions.</span>
<a name="l00065"></a>00065 <span class="comment"># @retval A 1 for success and a 0 for failure.</span>
<a name="l00066"></a><a class="code" href="namespacePyPedal_1_1pyp__jbc.html#dbc1c88a0fcf403645e7310f6b6da99f">00066</a> <span class="keyword">def </span><a class="code" href="namespacePyPedal_1_1pyp__jbc.html#dbc1c88a0fcf403645e7310f6b6da99f">color_pedigree</a>(pedobj, metric='descendants', places=2, drawer='new', **kw):
<a name="l00067"></a>00067     <span class="stringliteral">"""</span>
<a name="l00068"></a>00068 <span class="stringliteral">    color_pedigree() forms a graph object from a pedigree object and determines the</span>
<a name="l00069"></a>00069 <span class="stringliteral">    proportion of animals in a pedigree that are descendants of each animal in the</span>
<a name="l00070"></a>00070 <span class="stringliteral">    pedigree.  The results will be used to feed draw_colored_pedigree().</span>
<a name="l00071"></a>00071 <span class="stringliteral">    """</span>
<a name="l00072"></a>00072     _dprop = {}
<a name="l00073"></a>00073     <span class="keywordflow">if</span> metric == <span class="stringliteral">'descendants'</span>:
<a name="l00074"></a>00074         _pedgraph = pyp_network.ped_to_graph(pedobj)
<a name="l00075"></a>00075         <span class="comment"># Walk the pedigree and compute proportion of animals in the pedigree that are</span>
<a name="l00076"></a>00076         <span class="comment"># descended from each animal.</span>
<a name="l00077"></a>00077         <span class="keywordflow">for</span> _p <span class="keywordflow">in</span> pedobj.pedigree:
<a name="l00078"></a>00078             _dcount = pyp_network.find_descendants(_pedgraph,_p.animalID,[])
<a name="l00079"></a>00079             <span class="keywordflow">if</span> len(_dcount) &lt; 1:
<a name="l00080"></a>00080                 _dprop[_p.animalID] = 0.0
<a name="l00081"></a>00081             <span class="keywordflow">else</span>:
<a name="l00082"></a>00082                 _dprop[_p.animalID] = round(float(len(_dcount)) / float(pedobj.metadata.num_records), places)
<a name="l00083"></a>00083         del(_pedgraph)
<a name="l00084"></a>00084     <span class="keywordflow">elif</span> metric == <span class="stringliteral">'sons'</span>:
<a name="l00085"></a>00085         <span class="keywordflow">for</span> _p <span class="keywordflow">in</span> pedobj.pedigree:
<a name="l00086"></a>00086             _dprop[_p.animalID] = float(len(_p.sons))
<a name="l00087"></a>00087         <span class="comment">#print _dprop</span>
<a name="l00088"></a>00088     <span class="keywordflow">else</span>:
<a name="l00089"></a>00089       <span class="keywordflow">return</span> 0
<a name="l00090"></a>00090     <span class="keywordflow">if</span> drawer == <span class="stringliteral">'new'</span>:
<a name="l00091"></a>00091         new_draw_colored_pedigree(pedobj, _dprop, **kw)
<a name="l00092"></a>00092     <span class="keywordflow">else</span>:
<a name="l00093"></a>00093         draw_colored_pedigree(pedobj, _dprop, **kw)
<a name="l00094"></a>00094 
<a name="l00095"></a>00095 <span class="comment">##</span>
<a name="l00096"></a>00096 <span class="comment"># draw_colored_pedigree() uses the pydot bindings to the graphviz library to produce a</span>
<a name="l00097"></a>00097 <span class="comment"># directed graph of your pedigree with paths of inheritance as edges and animals as</span>
<a name="l00098"></a>00098 <span class="comment"># nodes.  If there is more than one generation in the pedigree as determind by the "gen"</span>
<a name="l00099"></a>00099 <span class="comment"># attributes of the animals in the pedigree, draw_pedigree() will use subgraphs to try</span>
<a name="l00100"></a>00100 <span class="comment"># and group animals in the same generation together in the drawing.  Nodes will be colored</span>
<a name="l00101"></a>00101 <span class="comment"># based on the number of outgoing connections (number of offspring).</span>
<a name="l00102"></a>00102 <span class="comment"># @param pedobj A PyPedal pedigree object.</span>
<a name="l00103"></a>00103 <span class="comment"># @param shading A dictionary mapping animal IDs to levels that will be used to color nodes.</span>
<a name="l00104"></a>00104 <span class="comment"># @param gfilename The name of the file to which the pedigree should be drawn.</span>
<a name="l00105"></a>00105 <span class="comment"># @param gtitle The title of the graph.</span>
<a name="l00106"></a>00106 <span class="comment"># @param gformat The format in which the output file should be written  (JPG|PNG|PS).</span>
<a name="l00107"></a>00107 <span class="comment"># @param gsize The size of the graph: 'f': full-size, 'l': letter-sized page.</span>
<a name="l00108"></a>00108 <span class="comment"># @param gdot Whether or not to write the dot code for the pedigree graph to a file (can produce large files).</span>
<a name="l00109"></a>00109 <span class="comment"># @param gorient The orientation of the graph: 'p': portrait, 'l': landscape.</span>
<a name="l00110"></a>00110 <span class="comment"># @param gdirec Direction of flow from parents to offspring: 'TB': top-bottom, 'LR': left-right, 'RL': right-left.</span>
<a name="l00111"></a>00111 <span class="comment"># @param gname Flag indicating whether ID numbers (0) or names (1) should be used to label nodes.</span>
<a name="l00112"></a>00112 <span class="comment"># @param gfontsize Integer indicating the typeface size to be used in labelling nodes.</span>
<a name="l00113"></a>00113 <span class="comment"># @param garrow Flag indicating whether or not arrowheads should be drawn.</span>
<a name="l00114"></a>00114 <span class="comment"># @param gtitloc Indicates if the title be drawn or above ('t') or below ('b') the graph.</span>
<a name="l00115"></a>00115 <span class="comment"># @param gtitjust Indicates if the title should be center- ('c'), left- ('l'), or right-justified ('r').</span>
<a name="l00116"></a>00116 <span class="comment"># @param ghatch Shade a node if the value of its userField attribute is equal to ghatch.</span>
<a name="l00117"></a>00117 <span class="comment"># @param gprog Program to use to layout graph ('dot'|'neato').</span>
<a name="l00118"></a>00118 <span class="comment"># @retval A 1 for success and a 0 for failure.</span>
<a name="l00119"></a><a class="code" href="namespacePyPedal_1_1pyp__jbc.html#dd01c0570f87aaac52c6cc89e39dacdb">00119</a> <span class="keyword">def </span><a class="code" href="namespacePyPedal_1_1pyp__jbc.html#dd01c0570f87aaac52c6cc89e39dacdb">draw_colored_pedigree</a>(pedobj, shading, gfilename='pedigree', gtitle='My_Pedigree', gformat='jpg', gsize='f', gdot='1', gorient='l', gdirec='', gname=0, gfontsize=10, garrow=1, gtitloc='b', gtitjust='c', ghatch='hatch', gprog='dot'):
<a name="l00120"></a>00120     <span class="stringliteral">"""</span>
<a name="l00121"></a>00121 <span class="stringliteral">    draw_colored_pedigree() uses the pydot bindings to the graphviz library to produce a</span>
<a name="l00122"></a>00122 <span class="stringliteral">    directed graph of your pedigree with paths of inheritance as edges and animals as</span>
<a name="l00123"></a>00123 <span class="stringliteral">    nodes.  If there is more than one generation in the pedigree as determind by the "gen"</span>
<a name="l00124"></a>00124 <span class="stringliteral">    attributes of the animals in the pedigree, draw_pedigree() will use subgraphs to try</span>
<a name="l00125"></a>00125 <span class="stringliteral">    and group animals in the same generation together in the drawing.  Nodes will be</span>
<a name="l00126"></a>00126 <span class="stringliteral">    colored based on the number of outgoing connections (number of offspring).</span>
<a name="l00127"></a>00127 <span class="stringliteral">    """</span>
<a name="l00128"></a>00128     <span class="keyword">from</span> pyp_utils <span class="keyword">import</span> string_to_table_name
<a name="l00129"></a>00129     _gtitle = string_to_table_name(gtitle)
<a name="l00130"></a>00130 
<a name="l00131"></a>00131     <span class="keywordflow">if</span> gtitloc <span class="keywordflow">not</span> <span class="keywordflow">in</span> [<span class="stringliteral">'t'</span>,<span class="stringliteral">'b'</span>]:
<a name="l00132"></a>00132         gtitloc = <span class="stringliteral">'b'</span>
<a name="l00133"></a>00133     <span class="keywordflow">if</span> gtitjust <span class="keywordflow">not</span> <span class="keywordflow">in</span> [<span class="stringliteral">'c'</span>,<span class="stringliteral">'l'</span>,<span class="stringliteral">'</span><span class="stringliteral">r']:</span>
<a name="l00134"></a>00134 <span class="stringliteral">        gtitjust = </span><span class="stringliteral">'c'</span>
<a name="l00135"></a>00135 
<a name="l00136"></a>00136     <span class="keywordflow">print</span> <span class="stringliteral">'[DEBUG]: Entered draw_colored_pedigree()'</span>
<a name="l00137"></a>00137 
<a name="l00138"></a>00138 <span class="comment">#     try:</span>
<a name="l00139"></a>00139     <span class="keyword">import</span> pydot
<a name="l00140"></a>00140 
<a name="l00141"></a>00141     <span class="comment"># Build a list of generations -- if we have more than on, we can use the</span>
<a name="l00142"></a>00142     <span class="comment"># "rank=same" option in dot to get nicer output.</span>
<a name="l00143"></a>00143     gens = pedobj.metadata.unique_gen_list
<a name="l00144"></a>00144     <span class="comment"># Set some properties for the graph.</span>
<a name="l00145"></a>00145     g = pydot.Dot(label=gtitle, labelloc=gtitloc, labeljust=gtitjust, graph_name=_gtitle, type=<span class="stringliteral">'graph'</span>, strict=<span class="keyword">False</span>, suppress_disconnected=<span class="keyword">True</span>, simplify=<span class="keyword">True</span>)
<a name="l00146"></a>00146 
<a name="l00147"></a>00147     <span class="comment"># Make sure that gfontsize has a valid value.</span>
<a name="l00148"></a>00148     <span class="keywordflow">try</span>:
<a name="l00149"></a>00149         gfontsize = int(gfontsize)
<a name="l00150"></a>00150     <span class="keywordflow">except</span>:
<a name="l00151"></a>00151         gfontsize = 10
<a name="l00152"></a>00152     <span class="keywordflow">if</span> gfontsize &lt; 10:
<a name="l00153"></a>00153         gfontsize = 10
<a name="l00154"></a>00154     gfontsize = str(gfontsize)
<a name="l00155"></a>00155 <span class="comment">#     print 'gfontsize = %s' % (gfontsize)</span>
<a name="l00156"></a>00156     g.set_page(<span class="stringliteral">"8.5,11"</span>)
<a name="l00157"></a>00157     g.set_size(<span class="stringliteral">"7.5,10"</span>)
<a name="l00158"></a>00158     <span class="keywordflow">if</span> gorient == <span class="stringliteral">'l'</span>:
<a name="l00159"></a>00159         g.set_orientation(<span class="stringliteral">"landscape"</span>)
<a name="l00160"></a>00160     <span class="keywordflow">else</span>:
<a name="l00161"></a>00161         g.set_orientation(<span class="stringliteral">"portrait"</span>)
<a name="l00162"></a>00162     <span class="keywordflow">if</span> gsize != <span class="stringliteral">'l'</span>:
<a name="l00163"></a>00163         g.set_ratio(<span class="stringliteral">"auto"</span>)
<a name="l00164"></a>00164     <span class="keywordflow">if</span> gdirec == <span class="stringliteral">'RL'</span>:
<a name="l00165"></a>00165         g.set_rankdir(<span class="stringliteral">'RL'</span>)
<a name="l00166"></a>00166     <span class="keywordflow">elif</span> gdirec == <span class="stringliteral">'LR'</span>:
<a name="l00167"></a>00167         g.set_rankdir(<span class="stringliteral">'LR'</span>)
<a name="l00168"></a>00168     <span class="keywordflow">else</span>:
<a name="l00169"></a>00169         <span class="keywordflow">pass</span>
<a name="l00170"></a>00170     g.set_center(<span class="stringliteral">'true'</span>)
<a name="l00171"></a>00171     g.set_concentrate(<span class="stringliteral">'true'</span>)
<a name="l00172"></a>00172     g.set_ordering(<span class="stringliteral">'out'</span>)
<a name="l00173"></a>00173     <span class="keywordflow">if</span> gformat <span class="keywordflow">not</span> <span class="keywordflow">in</span> g.formats:
<a name="l00174"></a>00174         gformat = <span class="stringliteral">'jpg'</span>
<a name="l00175"></a>00175     <span class="comment"># If we do not have any generations, we have to draw a less-nice graph.</span>
<a name="l00176"></a>00176     colormin = min(shading.values())
<a name="l00177"></a>00177     colormax = max(shading.values())
<a name="l00178"></a>00178     color_map = {}
<a name="l00179"></a>00179     <span class="keywordflow">if</span> len(gens) &lt;= 1:
<a name="l00180"></a>00180         animalCounter = 0
<a name="l00181"></a>00181         <span class="keywordflow">print</span> <span class="stringliteral">'\t[DEBUG]: Only one generation'</span>
<a name="l00182"></a>00182         <span class="keywordflow">for</span> _m <span class="keywordflow">in</span> pedobj.pedigree:
<a name="l00183"></a>00183             animalCounter = animalCounter + 1
<a name="l00184"></a>00184             <span class="keywordflow">if</span> numpy.fmod(animalCounter,pedobj.kw[<span class="stringliteral">'counter'</span>]) == 0:
<a name="l00185"></a>00185                 <span class="keywordflow">print</span> <span class="stringliteral">'\t[DEBUG]: Records read: %s '</span> % ( animalCounter )
<a name="l00186"></a>00186             <span class="comment"># Add a node for the current animal and set some properties.</span>
<a name="l00187"></a>00187             <span class="keywordflow">if</span> gname:
<a name="l00188"></a>00188                 _node_name = _m.name
<a name="l00189"></a>00189             <span class="keywordflow">else</span>:
<a name="l00190"></a>00190                 _node_name = _m.animalID
<a name="l00191"></a>00191             _an_node = pydot.Node(_node_name)
<a name="l00192"></a>00192             _an_node.set_fontname(<span class="stringliteral">'Helvetica'</span>)
<a name="l00193"></a>00193             <span class="comment"># _an_node.set_fontsize('10')</span>
<a name="l00194"></a>00194             _an_node.set_fontsize(gfontsize)
<a name="l00195"></a>00195             _an_node.set_height(<span class="stringliteral">'0.35'</span>)
<a name="l00196"></a>00196             <span class="keywordflow">if</span> _m.sex == <span class="stringliteral">'M'</span> <span class="keywordflow">or</span> _m.sex == <span class="stringliteral">'m'</span>:
<a name="l00197"></a>00197                 _an_node.set_shape(<span class="stringliteral">'box'</span>)
<a name="l00198"></a>00198             <span class="keywordflow">elif</span> _m.sex == <span class="stringliteral">'F'</span> <span class="keywordflow">or</span> _m.sex == <span class="stringliteral">'f'</span>:
<a name="l00199"></a>00199                 _an_node.set_shape(<span class="stringliteral">'ellipse'</span>)
<a name="l00200"></a>00200             <span class="keywordflow">else</span>:
<a name="l00201"></a>00201                 <span class="keywordflow">pass</span>
<a name="l00202"></a>00202             <span class="comment">#print _m.userField, ghatch, ( _m.userField == ghatch )</span>
<a name="l00203"></a>00203             <span class="keywordflow">if</span> _m.userField == ghatch:
<a name="l00204"></a>00204                 _an_node.set_style(<span class="stringliteral">'filled,peripheries=2'</span>)
<a name="l00205"></a>00205             <span class="keywordflow">else</span>:
<a name="l00206"></a>00206                 _an_node.set_style(<span class="stringliteral">'filled'</span>)
<a name="l00207"></a>00207             <span class="keywordflow">try</span>:
<a name="l00208"></a>00208                 _color = color_map[shading[_m.animalID]]
<a name="l00209"></a>00209             <span class="keywordflow">except</span> KeyError:
<a name="l00210"></a>00210                 _color = get_color_32(shading[_m.animalID], colormin, colormax)
<a name="l00211"></a>00211                 color_map[shading[_m.animalID]] = _color
<a name="l00212"></a>00212                 <span class="keywordflow">print</span> <span class="stringliteral">'\t[DEBUG]: %s added to cache'</span> % ( _color )
<a name="l00213"></a>00213             _an_node.set_fillcolor(_color)
<a name="l00214"></a>00214             g.add_node(_an_node)
<a name="l00215"></a>00215             <span class="comment"># Add the edges to the parent nodes, if any.</span>
<a name="l00216"></a>00216             <span class="keywordflow">if</span> _m.sireID != pedobj.kw[<span class="stringliteral">'missing_parent'</span>]:
<a name="l00217"></a>00217                 <span class="keywordflow">if</span> gname:
<a name="l00218"></a>00218                     <span class="keywordflow">if</span> garrow:
<a name="l00219"></a>00219                         g.add_edge(pydot.Edge(pedobj.pedigree[int(_m.sireID)-1].name, _m.name))
<a name="l00220"></a>00220                     <span class="keywordflow">else</span>:
<a name="l00221"></a>00221                         g.add_edge(pydot.Edge(pedobj.pedigree[int(_m.sireID)-1].name, _m.name, dir=<span class="stringliteral">'none'</span>))
<a name="l00222"></a>00222                 <span class="keywordflow">else</span>:
<a name="l00223"></a>00223                     <span class="keywordflow">if</span> garrow:
<a name="l00224"></a>00224                         g.add_edge(pydot.Edge(pedobj.pedigree[int(_m.sireID)-1].originalID,_m.originalID))
<a name="l00225"></a>00225                     <span class="keywordflow">else</span>:
<a name="l00226"></a>00226                         g.add_edge(pydot.Edge(pedobj.pedigree[int(_m.sireID)-1].originalID,_m.originalID, dir=<span class="stringliteral">'none'</span>))
<a name="l00227"></a>00227             <span class="keywordflow">if</span> _m.damID != pedobj.kw[<span class="stringliteral">'missing_parent'</span>]:
<a name="l00228"></a>00228                 <span class="keywordflow">if</span> gname:
<a name="l00229"></a>00229                     <span class="keywordflow">if</span> garrow:
<a name="l00230"></a>00230                         g.add_edge(pydot.Edge(pedobj.pedigree[int(_m.damID)-1].name, _m.name))
<a name="l00231"></a>00231                     <span class="keywordflow">else</span>:
<a name="l00232"></a>00232                         g.add_edge(pydot.Edge(pedobj.pedigree[int(_m.damID)-1].name, _m.name, dir=<span class="stringliteral">'none'</span>))
<a name="l00233"></a>00233                 <span class="keywordflow">else</span>:
<a name="l00234"></a>00234                     <span class="keywordflow">if</span> garrow:
<a name="l00235"></a>00235                         g.add_edge(pydot.Edge(pedobj.pedigree[int(_m.damID)-1].originalID,_m.originalID))
<a name="l00236"></a>00236                     <span class="keywordflow">else</span>:
<a name="l00237"></a>00237                         g.add_edge(pydot.Edge(pedobj.pedigree[int(_m.damID)-1].originalID,_m.originalID, dir=<span class="stringliteral">'none'</span>))
<a name="l00238"></a>00238     <span class="comment"># Otherwise we can draw a nice graph.</span>
<a name="l00239"></a>00239     <span class="keywordflow">else</span>:
<a name="l00240"></a>00240         <span class="keywordflow">for</span> _g <span class="keywordflow">in</span> gens:
<a name="l00241"></a>00241             <span class="keywordflow">print</span> <span class="stringliteral">'\t[DEBUG]: Looping over generations'</span>
<a name="l00242"></a>00242             _sg_anims = []
<a name="l00243"></a>00243             _sg_name = <span class="stringliteral">'sg%s'</span> % (_g)
<a name="l00244"></a>00244             sg = pydot.Subgraph(graph_name=_sg_name, suppress_disconnected=<span class="keyword">True</span>, simplify=<span class="keyword">True</span>)
<a name="l00245"></a>00245             sg.set_simplify(<span class="keyword">True</span>)
<a name="l00246"></a>00246             animalCounter = 0
<a name="l00247"></a>00247             <span class="keywordflow">for</span> _m <span class="keywordflow">in</span> pedobj.pedigree:
<a name="l00248"></a>00248                 animalCounter = animalCounter + 1
<a name="l00249"></a>00249                 <span class="keywordflow">if</span> numpy.fmod(animalCounter,pedobj.kw[<span class="stringliteral">'counter'</span>]) == 0:
<a name="l00250"></a>00250                     <span class="keywordflow">print</span> <span class="stringliteral">'\t[DEBUG]: Records read: %s '</span> % ( animalCounter )
<a name="l00251"></a>00251                 <span class="keywordflow">if</span> int(_m.gen) == int(_g):
<a name="l00252"></a>00252                     _sg_anims.append(_m.animalID)
<a name="l00253"></a>00253                 <span class="comment"># Add a node for the current animal and set some properties.</span>
<a name="l00254"></a>00254                 <span class="keywordflow">if</span> gname:
<a name="l00255"></a>00255                     _node_name = _m.name
<a name="l00256"></a>00256                 <span class="keywordflow">else</span>:
<a name="l00257"></a>00257                     _node_name = _m.animalID
<a name="l00258"></a>00258                 _an_node = pydot.Node(_node_name)
<a name="l00259"></a>00259                 _an_node.set_fontname(<span class="stringliteral">'Helvetica'</span>)
<a name="l00260"></a>00260                 _an_node.set_fontsize(gfontsize)
<a name="l00261"></a>00261                 _an_node.set_height(<span class="stringliteral">'0.35'</span>)
<a name="l00262"></a>00262                 <span class="keywordflow">if</span> _m.sex == <span class="stringliteral">'M'</span> <span class="keywordflow">or</span> _m.sex == <span class="stringliteral">'m'</span>:
<a name="l00263"></a>00263                     _an_node.set_shape(<span class="stringliteral">'box'</span>)
<a name="l00264"></a>00264                 <span class="keywordflow">elif</span> _m.sex == <span class="stringliteral">'F'</span> <span class="keywordflow">or</span> _m.sex == <span class="stringliteral">'f'</span>:
<a name="l00265"></a>00265                     _an_node.set_shape(<span class="stringliteral">'ellipse'</span>)
<a name="l00266"></a>00266                 <span class="keywordflow">else</span>:
<a name="l00267"></a>00267                     <span class="keywordflow">pass</span>
<a name="l00268"></a>00268                 <span class="keywordflow">if</span> _m.userField == ghatch:
<a name="l00269"></a>00269                     _an_node.set_style(<span class="stringliteral">'filled,peripheries=2'</span>)
<a name="l00270"></a>00270                 <span class="keywordflow">else</span>:
<a name="l00271"></a>00271                     _an_node.set_style(<span class="stringliteral">'filled'</span>)
<a name="l00272"></a>00272                 _color = get_color_32(shading[_m.animalID], colormin, colormax)
<a name="l00273"></a>00273                 _an_node.set_fillcolor(_color)
<a name="l00274"></a>00274                 sg.add_node(_an_node)
<a name="l00275"></a>00275                 <span class="comment"># Add the edges to the parent nodes, if any.</span>
<a name="l00276"></a>00276                 <span class="keywordflow">if</span> _m.sireID != pedobj.kw[<span class="stringliteral">'missing_parent'</span>]:
<a name="l00277"></a>00277                     <span class="keywordflow">if</span> gname:
<a name="l00278"></a>00278                         <span class="keywordflow">if</span> garrow:
<a name="l00279"></a>00279                             sg.add_edge(pydot.Edge(pedobj.pedigree[int(_m.sireID)-1].name,_m.name))
<a name="l00280"></a>00280                         <span class="keywordflow">else</span>:
<a name="l00281"></a>00281                             sg.add_edge(pydot.Edge(pedobj.pedigree[int(_m.sireID)-1].name,_m.name, dir=<span class="stringliteral">'none'</span>))
<a name="l00282"></a>00282                     <span class="keywordflow">else</span>:
<a name="l00283"></a>00283                         <span class="keywordflow">if</span> garrow:
<a name="l00284"></a>00284                             sg.add_edge(pydot.Edge(pedobj.pedigree[int(_m.sireID)-1].originalID,_m.originalID))
<a name="l00285"></a>00285                         <span class="keywordflow">else</span>:
<a name="l00286"></a>00286                             sg.add_edge(pydot.Edge(pedobj.pedigree[int(_m.sireID)-1].originalID,_m.originalID, dir=<span class="stringliteral">'none'</span>))
<a name="l00287"></a>00287                 <span class="comment">#if int(_m.damID) != 0:</span>
<a name="l00288"></a>00288                 <span class="keywordflow">if</span> _m.damID != pedobj.kw[<span class="stringliteral">'missing_parent'</span>]:
<a name="l00289"></a>00289                     <span class="keywordflow">if</span> gname:
<a name="l00290"></a>00290                         <span class="keywordflow">if</span> garrow:
<a name="l00291"></a>00291                             sg.add_edge(pydot.Edge(pedobj.pedigree[int(_m.damID)-1].name,_m.name))
<a name="l00292"></a>00292                         <span class="keywordflow">else</span>:
<a name="l00293"></a>00293                             sg.add_edge(pydot.Edge(pedobj.pedigree[int(_m.damID)-1].name,_m.name, dir=<span class="stringliteral">'none'</span>))
<a name="l00294"></a>00294                     <span class="keywordflow">else</span>:
<a name="l00295"></a>00295                         <span class="keywordflow">if</span> garrow:
<a name="l00296"></a>00296                             sg.add_edge(pydot.Edge(pedobj.pedigree[int(_m.damID)-1].originalID,_m.originalID))
<a name="l00297"></a>00297                         <span class="keywordflow">else</span>:
<a name="l00298"></a>00298                             sg.add_edge(pydot.Edge(pedobj.pedigree[int(_m.damID)-1].originalID,_m.originalID, dir=<span class="stringliteral">'none'</span>))
<a name="l00299"></a>00299             <span class="keywordflow">if</span> len(_sg_anims) &gt; 0:
<a name="l00300"></a>00300                 _sg_list = <span class="stringliteral">''</span>
<a name="l00301"></a>00301                 <span class="keywordflow">for</span> _a <span class="keywordflow">in</span> _sg_anims:
<a name="l00302"></a>00302                     <span class="keywordflow">if</span> len(_sg_list) == 0:
<a name="l00303"></a>00303                         _sg_list = <span class="stringliteral">'same,%s'</span> % (_a)
<a name="l00304"></a>00304                     <span class="keywordflow">else</span>:
<a name="l00305"></a>00305                         _sg_list = <span class="stringliteral">'%s,%s'</span> % (_sg_list,_a)
<a name="l00306"></a>00306             sg.set_rank(_sg_list)
<a name="l00307"></a>00307             g.add_subgraph(sg)
<a name="l00308"></a>00308     <span class="comment"># For large graphs it is nice to write out the .dot file so that it does not have to be recreated</span>
<a name="l00309"></a>00309     <span class="comment"># whenever draw_pedigree is called.  Especially when I am debugging.  :-)</span>
<a name="l00310"></a>00310     <span class="keywordflow">if</span> gdot:
<a name="l00311"></a>00311         dfn = <span class="stringliteral">'%s.dot'</span> % (gfilename)
<a name="l00312"></a>00312 <span class="comment">#             try:</span>
<a name="l00313"></a>00313         g.write(dfn)
<a name="l00314"></a>00314 <span class="comment">#             except:</span>
<a name="l00315"></a>00315 <span class="comment">#                 pass</span>
<a name="l00316"></a>00316     <span class="comment"># Write the graph to an output file.</span>
<a name="l00317"></a>00317     outfile = <span class="stringliteral">'%s.%s'</span> % (gfilename,gformat)
<a name="l00318"></a>00318     <span class="keywordflow">if</span> gprog <span class="keywordflow">not</span> <span class="keywordflow">in</span> [<span class="stringliteral">'dot'</span>,<span class="stringliteral">'neato'</span>,<span class="stringliteral">'none'</span>]:
<a name="l00319"></a>00319         gprog = <span class="stringliteral">'dot'</span>
<a name="l00320"></a>00320     <span class="keywordflow">if</span> gprog != <span class="stringliteral">'none'</span>:
<a name="l00321"></a>00321         g.write(outfile,prog=gprog,format=gformat)
<a name="l00322"></a>00322     <span class="keywordflow">return</span> 1
<a name="l00323"></a>00323 <span class="comment">#     except:</span>
<a name="l00324"></a>00324 <span class="comment">#         return 0</span>
<a name="l00325"></a>00325 
<a name="l00326"></a>00326 <span class="comment">##</span>
<a name="l00327"></a>00327 <span class="comment"># new_draw_colored_pedigree() uses the pyygraphviz to produce a directed graph of your</span>
<a name="l00328"></a>00328 <span class="comment"># pedigree with paths of inheritance as edges and animals as nodes.  If there</span>
<a name="l00329"></a>00329 <span class="comment"># is more than one generation in the pedigree as determind by the "gen"</span>
<a name="l00330"></a>00330 <span class="comment"># attributes of the animals in the pedigree, draw_pedigree() will use subgraphs</span>
<a name="l00331"></a>00331 <span class="comment"># to try and group animals in the same generation together in the drawing.</span>
<a name="l00332"></a>00332 <span class="comment"># @param pedobj A PyPedal pedigree object.</span>
<a name="l00333"></a>00333 <span class="comment"># @param shading A dictionary mapping animal IDs to levels that will be used to color nodes.</span>
<a name="l00334"></a>00334 <span class="comment"># @param gfilename The name of the file to which the pedigree should be drawn</span>
<a name="l00335"></a>00335 <span class="comment"># @param gtitle The title of the graph.</span>
<a name="l00336"></a>00336 <span class="comment"># @param gformat The format in which the output file should be written  (JPG|PNG|PS).</span>
<a name="l00337"></a>00337 <span class="comment"># @param gsize The size of the graph: 'f': full-size, 'l': letter-sized page.</span>
<a name="l00338"></a>00338 <span class="comment"># @param gdot Whether or not to write the dot code for the pedigree graph to a file (can produce large files).</span>
<a name="l00339"></a>00339 <span class="comment"># @param gorient The orientation of the graph: 'p': portrait, 'l': landscape.</span>
<a name="l00340"></a>00340 <span class="comment"># @param gdirec Direction of flow from parents to offspring: 'TB': top-bottom, 'LR': left-right, 'RL': right-left.</span>
<a name="l00341"></a>00341 <span class="comment"># @param gname Flag indicating whether ID numbers (0) or names (1) should be used to label nodes.</span>
<a name="l00342"></a>00342 <span class="comment"># @param garrow Flag indicating whether or not arrowheads should be drawn.</span>
<a name="l00343"></a>00343 <span class="comment"># @param gtitloc Indicates if the title be drawn or above ('t') or below ('b') the graph.</span>
<a name="l00344"></a>00344 <span class="comment"># @param gtitjust Indicates if the title should be center- ('c'), left- ('l'), or right-justified ('r').</span>
<a name="l00345"></a>00345 <span class="comment"># @param gshowall Draws animals with no links to other ancestors in the pedigree (1) or suppresses them (0).</span>
<a name="l00346"></a>00346 <span class="comment"># @param gprog Specify which program should be used to position and render the graph.</span>
<a name="l00347"></a>00347 <span class="comment"># @param ghatch Shade a node if the value of its userField attribute is equal to ghatch.</span>
<a name="l00348"></a>00348 <span class="comment"># @retval A 1 for success and a 0 for failure.</span>
<a name="l00349"></a><a class="code" href="namespacePyPedal_1_1pyp__jbc.html#3b775faed2b4c51293a105869000d32e">00349</a> <span class="keyword">def </span><a class="code" href="namespacePyPedal_1_1pyp__jbc.html#3b775faed2b4c51293a105869000d32e">new_draw_colored_pedigree</a>(pedobj, shading, gfilename='pedigree', \
<a name="l00350"></a>00350     gtitle=<span class="stringliteral">''</span>, gformat=<span class="stringliteral">'jpg'</span>, gsize=<span class="stringliteral">'f'</span>, gdot=1, gorient=<span class="stringliteral">'p'</span>, gdirec=<span class="stringliteral">''</span>, \
<a name="l00351"></a>00351     gname=0, garrow=1, gtitloc=<span class="stringliteral">'b'</span>, gtitjust=<span class="stringliteral">'c'</span>, gshowall=1, gprog=<span class="stringliteral">'dot'</span>, \
<a name="l00352"></a>00352     ghatch=<span class="stringliteral">'hatch'</span>):
<a name="l00353"></a>00353     <span class="stringliteral">"""</span>
<a name="l00354"></a>00354 <span class="stringliteral">    draw_pedigree() uses the pydot bindings to the graphviz library -- if they</span>
<a name="l00355"></a>00355 <span class="stringliteral">    are available on your system -- to produce a directed graph of your pedigree</span>
<a name="l00356"></a>00356 <span class="stringliteral">    with paths of inheritance as edges and animals as nodes.  If there is more than</span>
<a name="l00357"></a>00357 <span class="stringliteral">    one generation in the pedigree as determind by the "gen" attributes of the animals</span>
<a name="l00358"></a>00358 <span class="stringliteral">    in the pedigree, draw_pedigree() will use subgraphs to try and group animals in the</span>
<a name="l00359"></a>00359 <span class="stringliteral">    same generation together in the drawing.</span>
<a name="l00360"></a>00360 <span class="stringliteral">    """</span>
<a name="l00361"></a>00361 
<a name="l00362"></a>00362     <span class="keywordflow">try</span>:
<a name="l00363"></a>00363         <span class="keyword">import</span> pygraphviz
<a name="l00364"></a>00364     <span class="keywordflow">except</span> ImportError:
<a name="l00365"></a>00365         <span class="keywordflow">if</span> pedobj.kw[<span class="stringliteral">'messages'</span>] == <span class="stringliteral">'verbose'</span>:
<a name="l00366"></a>00366             <span class="keywordflow">print</span> <span class="stringliteral">'[ERROR]: pyp_graphics/new_draw_pedigree() was unable to import the pygraphviz module!'</span>
<a name="l00367"></a>00367         logging.error(<span class="stringliteral">'pyp_graphics/new_draw_pedigree() was unable to import the pygraphviz module!'</span>)
<a name="l00368"></a>00368         <span class="keywordflow">return</span> 0
<a name="l00369"></a>00369 
<a name="l00370"></a>00370     <span class="comment"># Maps the 0/1 flags taken by the function and maps them to Python</span>
<a name="l00371"></a>00371     <span class="comment"># True/False for settine edge and node attributes.</span>
<a name="l00372"></a>00372     _tf = {0:<span class="keyword">False</span>, 1:<span class="keyword">True</span>}
<a name="l00373"></a>00373 
<a name="l00374"></a>00374     <span class="keyword">from</span> pyp_utils <span class="keyword">import</span> string_to_table_name
<a name="l00375"></a>00375     _gtitle = string_to_table_name(gtitle)
<a name="l00376"></a>00376 
<a name="l00377"></a>00377     <span class="keywordflow">if</span> gtitloc <span class="keywordflow">not</span> <span class="keywordflow">in</span> [<span class="stringliteral">'t'</span>,<span class="stringliteral">'b'</span>]:
<a name="l00378"></a>00378         gtitloc = <span class="stringliteral">'b'</span>
<a name="l00379"></a>00379     <span class="keywordflow">if</span> gtitjust <span class="keywordflow">not</span> <span class="keywordflow">in</span> [<span class="stringliteral">'c'</span>,<span class="stringliteral">'l'</span>,<span class="stringliteral">'</span><span class="stringliteral">r']:</span>
<a name="l00380"></a>00380 <span class="stringliteral">        gtitjust = </span><span class="stringliteral">'c'</span>
<a name="l00381"></a>00381 
<a name="l00382"></a>00382     <span class="keywordflow">if</span> <span class="keywordflow">not</span> pedobj.kw[<span class="stringliteral">'pedigree_is_renumbered'</span>]:
<a name="l00383"></a>00383         <span class="keywordflow">if</span> pedobj.kw[<span class="stringliteral">'messages'</span>] != <span class="stringliteral">'quiet'</span>:
<a name="l00384"></a>00384             <span class="keywordflow">print</span> <span class="stringliteral">'[GRAPH]: The pedigree that you passed to pyp_graphics/draw_pedigree() is not renumbered. Because of this, there may be errors in the rendered pedigree. In order to insure that the pedigree drawing is accurate, you should renumber the pedigree before calling draw_pedigree().'</span>
<a name="l00385"></a>00385         logging.error(<span class="stringliteral">'The pedigree that you passed to pyp_graphics/draw_pedigree() is not renumbered. Because of this, there may be errors in the rendered pedigree. In order to insure that the pedigree drawing is accurate, you should renumber the pedigree before calling draw_pedigree().'</span>)
<a name="l00386"></a>00386 
<a name="l00387"></a>00387     <span class="comment"># Create an empty pygraphviz graph using the Agraph class.</span>
<a name="l00388"></a>00388     g = pygraphviz.AGraph(directed=<span class="keyword">True</span>,strict=<span class="keyword">False</span>)
<a name="l00389"></a>00389 
<a name="l00390"></a>00390     <span class="comment"># I'm not sure if I need to have this here or not.</span>
<a name="l00391"></a>00391     g.graph_attr[<span class="stringliteral">'type'</span>] = <span class="stringliteral">'graph'</span>
<a name="l00392"></a>00392 
<a name="l00393"></a>00393     <span class="comment"># Name the graph -- _gtitle has the characters removed which would cause</span>
<a name="l00394"></a>00394     <span class="comment"># dotfile processing to break.</span>
<a name="l00395"></a>00395     g.graph_attr[<span class="stringliteral">'name'</span>] = _gtitle
<a name="l00396"></a>00396 
<a name="l00397"></a>00397     <span class="comment"># Set some properties for the graph.  The label attribute is based on the gtitle.</span>
<a name="l00398"></a>00398     <span class="comment"># In cases where an empty string, e.g. '', is provided as the gtitle dot engine</span>
<a name="l00399"></a>00399     <span class="comment"># processing breaks.  In such cases, don't add a label.</span>
<a name="l00400"></a>00400 
<a name="l00401"></a>00401     <span class="keywordflow">if</span> gtitle != <span class="stringliteral">''</span>:
<a name="l00402"></a>00402         g.graph_attr[<span class="stringliteral">'label'</span>] = gtitle
<a name="l00403"></a>00403         g.graph_attr[<span class="stringliteral">'labelloc'</span>] = gtitloc
<a name="l00404"></a>00404         g.graph_attr[<span class="stringliteral">'labeljust'</span>] = gtitjust
<a name="l00405"></a>00405 
<a name="l00406"></a>00406     <span class="comment"># Set the page paper size and writeable area.</span>
<a name="l00407"></a>00407     g.graph_attr[<span class="stringliteral">'page'</span>] = <span class="stringliteral">'8.5,11'</span>
<a name="l00408"></a>00408     g.graph_attr[<span class="stringliteral">'size'</span>] = <span class="stringliteral">'7.5,10'</span>
<a name="l00409"></a>00409 
<a name="l00410"></a>00410     <span class="comment"># Set the page orientation.</span>
<a name="l00411"></a>00411     <span class="keywordflow">if</span> gorient == <span class="stringliteral">'l'</span>:
<a name="l00412"></a>00412         g.graph_attr[<span class="stringliteral">'orientation'</span>] = <span class="stringliteral">'landscape'</span>
<a name="l00413"></a>00413     <span class="keywordflow">else</span>:
<a name="l00414"></a>00414         g.graph_attr[<span class="stringliteral">'orientation'</span>] = <span class="stringliteral">'portrait'</span>
<a name="l00415"></a>00415 
<a name="l00416"></a>00416     <span class="keywordflow">if</span> gsize != <span class="stringliteral">'l'</span>:
<a name="l00417"></a>00417         g.graph_attr[<span class="stringliteral">'ratio'</span>] = <span class="stringliteral">'auto'</span>
<a name="l00418"></a>00418     <span class="keywordflow">if</span> gdirec == <span class="stringliteral">'RL'</span>:
<a name="l00419"></a>00419         g.graph_attr[<span class="stringliteral">'rankdir'</span>] = <span class="stringliteral">'RL'</span>
<a name="l00420"></a>00420     <span class="keywordflow">elif</span> gdirec == <span class="stringliteral">'LR'</span>:
<a name="l00421"></a>00421         g.graph_attr[<span class="stringliteral">'rankdir'</span>] = <span class="stringliteral">'LR'</span>
<a name="l00422"></a>00422     <span class="keywordflow">else</span>:
<a name="l00423"></a>00423         <span class="keywordflow">pass</span>
<a name="l00424"></a>00424 
<a name="l00425"></a>00425     <span class="comment"># Set a few other graph properties.</span>
<a name="l00426"></a>00426     g.graph_attr[<span class="stringliteral">'center'</span>] = <span class="stringliteral">'True'</span>
<a name="l00427"></a>00427     g.graph_attr[<span class="stringliteral">'concentrate'</span>] = <span class="stringliteral">'True'</span>
<a name="l00428"></a>00428     g.graph_attr[<span class="stringliteral">'fontsize'</span>] = str(pedobj.kw[<span class="stringliteral">'default_fontsize'</span>])
<a name="l00429"></a>00429     g.graph_attr[<span class="stringliteral">'ordering'</span>] = <span class="stringliteral">'out'</span>
<a name="l00430"></a>00430 
<a name="l00431"></a>00431     <span class="comment"># We need this for coloring the pedigree</span>
<a name="l00432"></a>00432     colormin = min(shading.values())
<a name="l00433"></a>00433     colormax = max(shading.values())
<a name="l00434"></a>00434     color_map = {}
<a name="l00435"></a>00435 
<a name="l00436"></a>00436     <span class="keywordflow">for</span> _m <span class="keywordflow">in</span> pedobj.pedigree:
<a name="l00437"></a>00437         <span class="comment"># Add a node for the current animal and set some node properties.</span>
<a name="l00438"></a>00438         <span class="keywordflow">if</span> gname:
<a name="l00439"></a>00439             _node_name = _m.name
<a name="l00440"></a>00440         <span class="keywordflow">else</span>:
<a name="l00441"></a>00441             _node_name = _m.animalID
<a name="l00442"></a>00442         g.add_node(_node_name)
<a name="l00443"></a>00443         n = g.get_node(_node_name)
<a name="l00444"></a>00444         n.attr[<span class="stringliteral">'shape'</span>] = <span class="stringliteral">'box'</span>
<a name="l00445"></a>00445         n.attr[<span class="stringliteral">'fontname'</span>] = <span class="stringliteral">'Helvetica'</span>
<a name="l00446"></a>00446         n.attr[<span class="stringliteral">'fontsize'</span>] = str(pedobj.kw[<span class="stringliteral">'default_fontsize'</span>])
<a name="l00447"></a>00447         n.attr[<span class="stringliteral">'height'</span>] = <span class="stringliteral">'0.35'</span>
<a name="l00448"></a>00448         <span class="comment">#print '[DEBUG]: sex = ', _m.sex</span>
<a name="l00449"></a>00449         <span class="keywordflow">if</span> _m.sex == <span class="stringliteral">'M'</span> <span class="keywordflow">or</span> _m.sex == <span class="stringliteral">'m'</span>:
<a name="l00450"></a>00450             n.attr[<span class="stringliteral">'shape'</span>] = <span class="stringliteral">'box'</span>
<a name="l00451"></a>00451         <span class="keywordflow">elif</span> _m.sex == <span class="stringliteral">'F'</span> <span class="keywordflow">or</span> _m.sex == <span class="stringliteral">'f'</span>:
<a name="l00452"></a>00452             n.attr[<span class="stringliteral">'shape'</span>] = <span class="stringliteral">'ellipse'</span>
<a name="l00453"></a>00453         <span class="keywordflow">else</span>:
<a name="l00454"></a>00454             n.attr[<span class="stringliteral">'shape'</span>] = <span class="stringliteral">'octagon'</span>
<a name="l00455"></a>00455             <span class="comment">#pass</span>
<a name="l00456"></a>00456 
<a name="l00457"></a>00457         <span class="comment"># Color the nodes</span>
<a name="l00458"></a>00458         <span class="keywordflow">if</span> _m.userField == ghatch:
<a name="l00459"></a>00459             n.attr[<span class="stringliteral">'style'</span>] = <span class="stringliteral">'filled,peripheries=2'</span>
<a name="l00460"></a>00460         <span class="keywordflow">else</span>:
<a name="l00461"></a>00461             n.attr[<span class="stringliteral">'style'</span>] = <span class="stringliteral">'filled'</span>
<a name="l00462"></a>00462             _color = get_color_32(shading[_m.animalID], colormin, colormax)
<a name="l00463"></a>00463             n.attr[<span class="stringliteral">'fillcolor'</span>] = _color
<a name="l00464"></a>00464             <span class="comment"># Add values to the color map</span>
<a name="l00465"></a>00465             <span class="keywordflow">if</span> <span class="keywordflow">not</span> color_map.has_key(shading[_m.animalID]):
<a name="l00466"></a>00466                 color_map[shading[_m.animalID]] = _color
<a name="l00467"></a>00467 
<a name="l00468"></a>00468         <span class="comment"># Add the edges to the parent nodes, if any.</span>
<a name="l00469"></a>00469         <span class="keywordflow">if</span> _m.sireID != pedobj.kw[<span class="stringliteral">'missing_parent'</span>]:
<a name="l00470"></a>00470             <span class="keywordflow">if</span> gname:
<a name="l00471"></a>00471                 _sire_edge = pedobj.pedigree[int(_m.sireID)-1].name
<a name="l00472"></a>00472             <span class="keywordflow">else</span>:
<a name="l00473"></a>00473                 <span class="comment"># Check some outputs -- should I be using the animalID or the</span>
<a name="l00474"></a>00474                 <span class="comment"># originalID to assign edges? Nodes are based on the animalID,</span>
<a name="l00475"></a>00475                 <span class="comment"># so edges should also be in order to maintain consistency.</span>
<a name="l00476"></a>00476                 <span class="comment">#_sire_edge = pedobj.pedigree[int(_m.sireID)-1].originalID</span>
<a name="l00477"></a>00477                 _sire_edge = pedobj.pedigree[int(_m.sireID)-1].animalID
<a name="l00478"></a>00478             g.add_edge(_sire_edge,_node_name)
<a name="l00479"></a>00479             <span class="keywordflow">if</span> <span class="keywordflow">not</span> _tf[garrow]:
<a name="l00480"></a>00480                 e = g.get_edge(_sire_edge,_anim_node)
<a name="l00481"></a>00481                 e.attr[<span class="stringliteral">'dir'</span>] = <span class="stringliteral">'none'</span>
<a name="l00482"></a>00482         <span class="keywordflow">if</span> _m.damID != pedobj.kw[<span class="stringliteral">'missing_parent'</span>]:
<a name="l00483"></a>00483             <span class="keywordflow">if</span> gname:
<a name="l00484"></a>00484                 _dam_edge = pedobj.pedigree[int(_m.damID)-1].name
<a name="l00485"></a>00485             <span class="keywordflow">else</span>:
<a name="l00486"></a>00486                 _dam_edge = pedobj.pedigree[int(_m.damID)-1].animalID
<a name="l00487"></a>00487             g.add_edge(_dam_edge,_node_name)
<a name="l00488"></a>00488             <span class="keywordflow">if</span> <span class="keywordflow">not</span> _tf[garrow]:
<a name="l00489"></a>00489                 e = g.get_edge(_dam_edge,_anim_node)
<a name="l00490"></a>00490                 e.attr[<span class="stringliteral">'dir'</span>] = <span class="stringliteral">'none'</span>
<a name="l00491"></a>00491 
<a name="l00492"></a>00492     <span class="comment"># For large graphs it is nice to write out the .dot file so that it does</span>
<a name="l00493"></a>00493     <span class="comment"># not have to be recreated whenever new_draw_pedigree is called.</span>
<a name="l00494"></a>00494     <span class="comment"># Especially when I am debugging.</span>
<a name="l00495"></a>00495     <span class="keywordflow">if</span> gdot:
<a name="l00496"></a>00496         dfn = <span class="stringliteral">'%s.dot'</span> % (gfilename)
<a name="l00497"></a>00497         <span class="keywordflow">try</span>:
<a name="l00498"></a>00498             g.write(dfn)
<a name="l00499"></a>00499         <span class="keywordflow">except</span>:
<a name="l00500"></a>00500             <span class="keywordflow">if</span> pedobj.kw[<span class="stringliteral">'messages'</span>] == <span class="stringliteral">'verbose'</span>:
<a name="l00501"></a>00501                 <span class="keywordflow">print</span> <span class="stringliteral">'[ERROR]: pyp_graphics/new_draw_pedigree() was unable to write the dotfile %s.'</span> % (dfn)
<a name="l00502"></a>00502             logging.error(<span class="stringliteral">'pyp_graphics/new_draw_pedigree() was unable to draw the dotfile %s.'</span>, (dfn))
<a name="l00503"></a>00503 
<a name="l00504"></a>00504 
<a name="l00505"></a>00505     <span class="comment"># Write the color map to a file.</span>
<a name="l00506"></a>00506     <span class="comment">#try:</span>
<a name="l00507"></a>00507     mapfile = <span class="stringliteral">'%s_color_map.txt'</span> % (gfilename)
<a name="l00508"></a>00508     mf = file(mapfile,<span class="stringliteral">'w'</span>)
<a name="l00509"></a>00509     mf.write(<span class="stringliteral">'# Color map data\n'</span>)
<a name="l00510"></a>00510     mf.write(<span class="stringliteral">'# Data are metric (number of sons/descendants/etc.) followed\n'</span>)
<a name="l00511"></a>00511     mf.write(<span class="stringliteral">'# by color in RGB.\n'</span>)
<a name="l00512"></a>00512     <span class="keywordflow">for</span> k,v <span class="keywordflow">in</span> color_map.iteritems():
<a name="l00513"></a>00513         line = <span class="stringliteral">'%s\t%s\n'</span> % (k,v)
<a name="l00514"></a>00514         mf.write(line)
<a name="l00515"></a>00515     mf.close()
<a name="l00516"></a>00516     <span class="comment">#except:</span>
<a name="l00517"></a>00517         <span class="comment">#outfile = '%s_color_map.txt' % (gfilename)</span>
<a name="l00518"></a>00518         <span class="comment">#if pedobj.kw['messages'] == 'verbose':</span>
<a name="l00519"></a>00519             <span class="comment">#print '[ERROR]: pyp_jbc/new_draw_colored_pedigree() was unable to write the color map %s.' % (outfile)</span>
<a name="l00520"></a>00520         <span class="comment">#logging.error('pyp_jbc/new_draw_colored_pedigree() was unable to write the color map %s.', (outfile))</span>
<a name="l00521"></a>00521         <span class="comment">#return 0</span>
<a name="l00522"></a>00522 
<a name="l00523"></a>00523     <span class="comment"># Write the graph to an output file.</span>
<a name="l00524"></a>00524     <span class="comment">#try:</span>
<a name="l00525"></a>00525     outfile = <span class="stringliteral">'%s.%s'</span> % (gfilename,gformat)
<a name="l00526"></a>00526     g.draw(outfile,prog=gprog)
<a name="l00527"></a>00527     <span class="keywordflow">return</span> 1
<a name="l00528"></a>00528     <span class="comment">#except:</span>
<a name="l00529"></a>00529         <span class="comment">#outfile = '%s.%s' % (gfilename,gformat)</span>
<a name="l00530"></a>00530         <span class="comment">#if pedobj.kw['messages'] == 'verbose':</span>
<a name="l00531"></a>00531             <span class="comment">#print '[ERROR]: pyp_jbc/new_draw_colored_pedigree() was unable to draw the pedigree %s.' % (outfile)</span>
<a name="l00532"></a>00532         <span class="comment">#logging.error('pyp_jbc/new_draw_colored_pedigree() was unable to draw the pedigree %s.', (outfile))</span>
<a name="l00533"></a>00533         <span class="comment">#return 0</span>
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Tue Sep 28 14:09:57 2010 for PyPedal by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.4.7 </small></address>
</body>
</html>
