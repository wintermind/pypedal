<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>PyPedal: PyPedal/pyp_io.py Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="namespaces.html"><span>Packages</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<h1>PyPedal/pyp_io.py</h1>  </div>
</div>
<div class="contents">
<div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">#!/usr/bin/python</span>
<a name="l00002"></a>00002 
<a name="l00003"></a>00003 <span class="comment">###############################################################################</span>
<a name="l00004"></a>00004 <span class="comment"># NAME: pyp_io.py</span>
<a name="l00005"></a>00005 <span class="comment"># VERSION: 2.0.0 (29SEPTEMBER2010)</span>
<a name="l00006"></a>00006 <span class="comment"># AUTHOR: John B. Cole, PhD (john.cole@ars.usda.gov)</span>
<a name="l00007"></a>00007 <span class="comment"># LICENSE: LGPL</span>
<a name="l00008"></a>00008 <span class="comment">###############################################################################</span>
<a name="l00009"></a>00009 <span class="comment"># FUNCTIONS:</span>
<a name="l00010"></a>00010 <span class="comment">#   a_inverse_from_file()</span>
<a name="l00011"></a>00011 <span class="comment">#   a_inverse_to_file()</span>
<a name="l00012"></a>00012 <span class="comment">#   dissertation_pedigree_to_file()</span>
<a name="l00013"></a>00013 <span class="comment">#   dissertation_pedigree_to_pedig_format()</span>
<a name="l00014"></a>00014 <span class="comment">#   dissertation_pedigree_to_pedig_interest_format()</span>
<a name="l00015"></a>00015 <span class="comment">#   dissertation_pedigree_to_pedig_format_mask()</span>
<a name="l00016"></a>00016 <span class="comment">#   pyp_file_header()</span>
<a name="l00017"></a>00017 <span class="comment">#   pyp_file_footer()</span>
<a name="l00018"></a>00018 <span class="comment">#   renderTitle()</span>
<a name="l00019"></a>00019 <span class="comment">#   renderBodyText()</span>
<a name="l00020"></a>00020 <span class="comment">#   pickle_pedigree()</span>
<a name="l00021"></a>00021 <span class="comment">#   unpickle_pedigree()</span>
<a name="l00022"></a>00022 <span class="comment">#   summary_inbreeding()</span>
<a name="l00023"></a>00023 <span class="comment">#   save_ijk()</span>
<a name="l00024"></a>00024 <span class="comment">#   load_from_gedcom()</span>
<a name="l00025"></a>00025 <span class="comment">#   save_from_gedcom()</span>
<a name="l00026"></a>00026 <span class="comment">#   save_to_gedcom()</span>
<a name="l00027"></a>00027 <span class="comment">#   load_from_genes()</span>
<a name="l00028"></a>00028 <span class="comment">#   save_from_genes()</span>
<a name="l00029"></a>00029 <span class="comment">#   save_to_genes()</span>
<a name="l00030"></a>00030 <span class="comment">###############################################################################</span>
<a name="l00031"></a>00031 
<a name="l00032"></a>00032 <span class="comment">## @package pyp_io</span>
<a name="l00033"></a>00033 <span class="comment"># pyp_io contains several procedures for writing structures to and reading them from</span>
<a name="l00034"></a>00034 <span class="comment"># disc (e.g. using pickle() to store and retrieve A and A-inverse).  It also includes a set</span>
<a name="l00035"></a>00035 <span class="comment"># of functions used to render strings as HTML or plaintext for use in generating output</span>
<a name="l00036"></a>00036 <span class="comment"># files.</span>
<a name="l00037"></a>00037 <span class="comment">##</span>
<a name="l00038"></a>00038 
<a name="l00039"></a>00039 <span class="keyword">import</span> logging, numpy, pickle, string, time
<a name="l00040"></a>00040 <span class="keyword">import</span> pyp_utils
<a name="l00041"></a>00041 
<a name="l00042"></a>00042 <span class="keyword">global</span> LINE1
<a name="l00043"></a>00043 <span class="keyword">global</span> LINE2
<a name="l00044"></a>00044 LINE1 = <span class="stringliteral">&#39;%s&#39;</span> % (<span class="stringliteral">&#39;=&#39;</span>*80)
<a name="l00045"></a>00045 LINE2 = <span class="stringliteral">&#39;%s&#39;</span> % (<span class="stringliteral">&#39;-&#39;</span>*80)
<a name="l00046"></a>00046 
<a name="l00047"></a>00047 <span class="comment">##</span>
<a name="l00048"></a>00048 <span class="comment"># a_inverse_to_file() uses the Python pickle system for persistent objects to write the</span>
<a name="l00049"></a>00049 <span class="comment"># inverse of a relationship matrix to a file.</span>
<a name="l00050"></a>00050 <span class="comment"># @param pedobj A PyPedal pedigree object.</span>
<a name="l00051"></a>00051 <span class="comment"># @param ainv The inverse of a numerator relationship matrix, A, or an empty string if A is to be calculated.</span>
<a name="l00052"></a>00052 <span class="comment"># @retval True (1) on success, false (0) on failure</span>
<a name="l00053"></a>00053 <span class="keyword">def </span>a_inverse_to_file(pedobj, ainv=&#39;&#39;):
<a name="l00054"></a>00054     <span class="stringliteral">&quot;&quot;&quot;</span>
<a name="l00055"></a>00055 <span class="stringliteral">    Use the Python pickle system for persistent objects to write the inverse of a relationship matrix to a file.</span>
<a name="l00056"></a>00056 <span class="stringliteral">    &quot;&quot;&quot;</span>
<a name="l00057"></a>00057     <span class="keywordflow">try</span>: logging.info(<span class="stringliteral">&#39;Entered a_inverse_to_file()&#39;</span>)
<a name="l00058"></a>00058     <span class="keywordflow">except</span>: <span class="keywordflow">pass</span>
<a name="l00059"></a>00059     <span class="keywordflow">try</span>:
<a name="l00060"></a>00060         <span class="keyword">from</span> pickle <span class="keyword">import</span> Pickler
<a name="l00061"></a>00061         <span class="keywordflow">if</span> <span class="keywordflow">not</span> ainv:
<a name="l00062"></a>00062             ainv = a_inverse_df(pedobj.pedigree,pedobj.kw[<span class="stringliteral">&#39;filetag&#39;</span>])
<a name="l00063"></a>00063         a_outputfile = <span class="stringliteral">&#39;%s%s%s&#39;</span> % (filetag,<span class="stringliteral">&#39;_a_inverse_pickled_&#39;</span>,<span class="stringliteral">&#39;.pkl&#39;</span>)
<a name="l00064"></a>00064         aout = open(a_outputfile,<span class="stringliteral">&#39;w&#39;</span>)
<a name="l00065"></a>00065         ap = pickle.Pickler(aout)
<a name="l00066"></a>00066         ap.dump(a)
<a name="l00067"></a>00067         aout.close()
<a name="l00068"></a>00068         _r = 1
<a name="l00069"></a>00069     <span class="keywordflow">except</span>:
<a name="l00070"></a>00070         _r = 0
<a name="l00071"></a>00071 
<a name="l00072"></a>00072     <span class="keywordflow">try</span>: logging.info(<span class="stringliteral">&#39;Exited a_inverse_to_file()&#39;</span>)
<a name="l00073"></a>00073     <span class="keywordflow">except</span>: <span class="keywordflow">pass</span>
<a name="l00074"></a>00074     <span class="keywordflow">return</span> _r
<a name="l00075"></a>00075 
<a name="l00076"></a>00076 <span class="comment">##</span>
<a name="l00077"></a>00077 <span class="comment"># a_inverse_from_file() uses the Python pickle system for persistent objects to read the inverse of</span>
<a name="l00078"></a>00078 <span class="comment"># a relationship matrix from a file.</span>
<a name="l00079"></a>00079 <span class="comment"># @param inputfile The name of the input file.</span>
<a name="l00080"></a>00080 <span class="comment"># @retval The inverse of a numerator relationship matrix.</span>
<a name="l00081"></a>00081 <span class="keyword">def </span>a_inverse_from_file(inputfile):
<a name="l00082"></a>00082     <span class="stringliteral">&quot;&quot;&quot;</span>
<a name="l00083"></a>00083 <span class="stringliteral">    Use the Python pickle system for persistent objects to read the inverse of a relationship matrix from a file.</span>
<a name="l00084"></a>00084 <span class="stringliteral">    &quot;&quot;&quot;</span>
<a name="l00085"></a>00085     <span class="keywordflow">try</span>: logging.info(<span class="stringliteral">&#39;Entered a_inverse_from_file()&#39;</span>)
<a name="l00086"></a>00086     <span class="keywordflow">except</span>: <span class="keywordflow">pass</span>
<a name="l00087"></a>00087     <span class="keywordflow">try</span>:
<a name="l00088"></a>00088         <span class="keyword">from</span> pickle <span class="keyword">import</span> Pickler
<a name="l00089"></a>00089         ain = open(inputfile,<span class="stringliteral">&#39;</span><span class="stringliteral">r&#39;)</span>
<a name="l00090"></a>00090 <span class="stringliteral">        au = pickle.Unpickler(ain)</span>
<a name="l00091"></a>00091 <span class="stringliteral">        a_inv = au.load()</span>
<a name="l00092"></a>00092 <span class="stringliteral">    </span><span class="keywordflow">except</span>:
<a name="l00093"></a>00093         a_inv = numpy.zeros([1,1],Float)
<a name="l00094"></a>00094     <span class="keywordflow">try</span>: logging.info(<span class="stringliteral">&#39;Exited a_inverse_from_file()&#39;</span>)
<a name="l00095"></a>00095     <span class="keywordflow">except</span>: <span class="keywordflow">pass</span>
<a name="l00096"></a>00096     <span class="keywordflow">return</span> a_inv
<a name="l00097"></a>00097 
<a name="l00098"></a>00098 <span class="comment">##</span>
<a name="l00099"></a>00099 <span class="comment"># dissertation_pedigree_to_file() takes a pedigree in &#39;asdxfg&#39; format and writes is to a file.</span>
<a name="l00100"></a>00100 <span class="comment"># @param pedobj A PyPedal pedigree object.</span>
<a name="l00101"></a>00101 <span class="comment"># @retval True (1) on success, false (0) on failure</span>
<a name="l00102"></a>00102 <span class="keyword">def </span>dissertation_pedigree_to_file(pedobj):
<a name="l00103"></a>00103     <span class="stringliteral">&quot;&quot;&quot;</span>
<a name="l00104"></a>00104 <span class="stringliteral">    dissertation_pedigree_to_file() takes a pedigree in &#39;asdxfg&#39; format and writes is to</span>
<a name="l00105"></a>00105 <span class="stringliteral">    a file.</span>
<a name="l00106"></a>00106 <span class="stringliteral">    &quot;&quot;&quot;</span>
<a name="l00107"></a>00107     <span class="comment"># This procedure assumes that the pedigree passed to it is in &#39;asdxfg&#39; format.</span>
<a name="l00108"></a>00108     <span class="keywordflow">try</span>: logging.info(<span class="stringliteral">&#39;Entered dissertation_pedigree_to_file()&#39;</span>)
<a name="l00109"></a>00109     <span class="keywordflow">except</span>: <span class="keywordflow">pass</span>
<a name="l00110"></a>00110     <span class="keywordflow">try</span>:
<a name="l00111"></a>00111         length = len(pedobj.pedigree)
<a name="l00112"></a>00112         <span class="comment">#print &#39;DEBUG: length of pedigree is %s&#39; % (length)</span>
<a name="l00113"></a>00113         outputfile = <span class="stringliteral">&#39;%s%s%s&#39;</span> % (pedobj.kw[<span class="stringliteral">&#39;filetag&#39;</span>],<span class="stringliteral">&#39;_diss&#39;</span>,<span class="stringliteral">&#39;.ped&#39;</span>)
<a name="l00114"></a>00114         <span class="keywordflow">print</span> <span class="stringliteral">&#39;\t\tWriting dissertation pedigree to %s&#39;</span> % (outputfile)
<a name="l00115"></a>00115         aout = open(outputfile,<span class="stringliteral">&#39;w&#39;</span>)
<a name="l00116"></a>00116         aout.write(<span class="stringliteral">&#39;# DISSERTATION pedigree produced by PyPedal.\n&#39;</span>)
<a name="l00117"></a>00117         aout.write(<span class="stringliteral">&#39;% asdbxfg\n&#39;</span>)
<a name="l00118"></a>00118         <span class="keywordflow">for</span> l <span class="keywordflow">in</span> range(length):
<a name="l00119"></a>00119             aout.write(<span class="stringliteral">&#39;%s,%s,%s,%s,%s,%s,%s\n&#39;</span> % pedobj.pedigree[l].animalID,pedobj.pedigree[l].sireID,pedobj.pedigree[l].damID,pedobj.pedigree[l].by, pedobj.pedigree[l].sex,pedobj.pedigree[l].fa,pedobj.pedigree[l].gen)
<a name="l00120"></a>00120         aout.close()
<a name="l00121"></a>00121         _r = 1
<a name="l00122"></a>00122     <span class="keywordflow">except</span>:
<a name="l00123"></a>00123         _r = 0
<a name="l00124"></a>00124     <span class="keywordflow">try</span>: logging.info(<span class="stringliteral">&#39;Exited dissertation_pedigree_to_file()&#39;</span>)
<a name="l00125"></a>00125     <span class="keywordflow">except</span>: <span class="keywordflow">pass</span>
<a name="l00126"></a>00126     <span class="keywordflow">return</span> _r
<a name="l00127"></a>00127 
<a name="l00128"></a>00128 <span class="comment">##</span>
<a name="l00129"></a>00129 <span class="comment"># dissertation_pedigree_to_pedig_format() takes a pedigree in &#39;asdbxfg&#39; format, formats it into</span>
<a name="l00130"></a>00130 <span class="comment"># the form used by Didier Boichard&#39;s &#39;pedig&#39; suite of programs, and writes it to a file.</span>
<a name="l00131"></a>00131 <span class="comment"># @param pedobj A PyPedal pedigree object.</span>
<a name="l00132"></a>00132 <span class="comment"># @retval True (1) on success, false (0) on failure</span>
<a name="l00133"></a>00133 <span class="keyword">def </span>dissertation_pedigree_to_pedig_format(pedobj):
<a name="l00134"></a>00134     <span class="stringliteral">&quot;&quot;&quot;</span>
<a name="l00135"></a>00135 <span class="stringliteral">    dissertation_pedigree_to_pedig_format() takes a pedigree in &#39;asdbxfg&#39; format, formats</span>
<a name="l00136"></a>00136 <span class="stringliteral">    it into the form used by Didier Boichard&#39;s &#39;pedig&#39; suite of programs, and writes it</span>
<a name="l00137"></a>00137 <span class="stringliteral">    to a file.</span>
<a name="l00138"></a>00138 <span class="stringliteral">    &quot;&quot;&quot;</span>
<a name="l00139"></a>00139     <span class="keywordflow">try</span>: logging.info(<span class="stringliteral">&#39;Entered dissertation_pedigree_to_pedig_format()&#39;</span>)
<a name="l00140"></a>00140     <span class="keywordflow">except</span>: <span class="keywordflow">pass</span>
<a name="l00141"></a>00141     <span class="keywordflow">try</span>:
<a name="l00142"></a>00142         length = len(pedobj.pedigree)
<a name="l00143"></a>00143         outputfile = <span class="stringliteral">&#39;%s%s%s&#39;</span> % (pedobj.kw[<span class="stringliteral">&#39;filetag&#39;</span>],<span class="stringliteral">&#39;_pedig&#39;</span>,<span class="stringliteral">&#39;.ped&#39;</span>)
<a name="l00144"></a>00144         aout = open(outputfile,<span class="stringliteral">&#39;w&#39;</span>)
<a name="l00145"></a>00145         <span class="keywordflow">for</span> l <span class="keywordflow">in</span> range(length):
<a name="l00146"></a>00146             <span class="keywordflow">if</span> pedobj.pedigree[l].sex == <span class="stringliteral">&#39;m&#39;</span> <span class="keywordflow">or</span> pedobj.pedigree[l].sex == <span class="stringliteral">&#39;M&#39;</span>:
<a name="l00147"></a>00147                     sex = 1
<a name="l00148"></a>00148             <span class="keywordflow">else</span>:
<a name="l00149"></a>00149                 sex = 2
<a name="l00150"></a>00150             aout.write(<span class="stringliteral">&#39;%s %s %s %s %s %s %s\n&#39;</span> % pedobj.pedigree[l].animalID,pedobj.pedigree[l].sireID,pedobj.pedigree[l].damID,pedobj.pedigree[l].by,sex,<span class="stringliteral">&#39;1&#39;</span>,<span class="stringliteral">&#39;1&#39;</span>)
<a name="l00151"></a>00151         aout.close()
<a name="l00152"></a>00152         _r = 1
<a name="l00153"></a>00153     <span class="keywordflow">except</span>:
<a name="l00154"></a>00154         _r = 0
<a name="l00155"></a>00155     <span class="keywordflow">try</span>: logging.info(<span class="stringliteral">&#39;Exited dissertation_pedigree_to_pedig_format()&#39;</span>)
<a name="l00156"></a>00156     <span class="keywordflow">except</span>: <span class="keywordflow">pass</span>
<a name="l00157"></a>00157     <span class="keywordflow">return</span> _r
<a name="l00158"></a>00158 
<a name="l00159"></a>00159 <span class="comment">##</span>
<a name="l00160"></a>00160 <span class="comment"># dissertation_pedigree_to_pedig_interest_format() takes a pedigree in &#39;asdbxfg&#39; format,</span>
<a name="l00161"></a>00161 <span class="comment"># formats it into the form used by Didier Boichard&#39;s parente program for the studied</span>
<a name="l00162"></a>00162 <span class="comment"># individuals file.</span>
<a name="l00163"></a>00163 <span class="comment"># @param pedobj A PyPedal pedigree object.</span>
<a name="l00164"></a>00164 <span class="comment"># @retval True (1) on success, false (0) on failure</span>
<a name="l00165"></a>00165 <span class="keyword">def </span>dissertation_pedigree_to_pedig_interest_format(pedobj):
<a name="l00166"></a>00166     <span class="stringliteral">&quot;&quot;&quot;</span>
<a name="l00167"></a>00167 <span class="stringliteral">    dissertation_pedigree_to_pedig_interest_format() takes a pedigree in &#39;asdbxfg&#39; format,</span>
<a name="l00168"></a>00168 <span class="stringliteral">    formats it into the form used by Didier Boichard&#39;s parente program for the studied</span>
<a name="l00169"></a>00169 <span class="stringliteral">    individuals file.</span>
<a name="l00170"></a>00170 <span class="stringliteral">    &quot;&quot;&quot;</span>
<a name="l00171"></a>00171     <span class="keywordflow">try</span>: logging.info(<span class="stringliteral">&#39;Entered dissertation_pedigree_to_pedig_interest_format()&#39;</span>)
<a name="l00172"></a>00172     <span class="keywordflow">except</span>: <span class="keywordflow">pass</span>
<a name="l00173"></a>00173     <span class="keywordflow">try</span>:
<a name="l00174"></a>00174         length = len(pedobj.pedigree)
<a name="l00175"></a>00175         outputfile = <span class="stringliteral">&#39;%s%s%s&#39;</span> % (pedobj.kw[<span class="stringliteral">&#39;filetag&#39;</span>],<span class="stringliteral">&#39;_parente&#39;</span>,<span class="stringliteral">&#39;.ped&#39;</span>)
<a name="l00176"></a>00176         aout = open(outputfile,<span class="stringliteral">&#39;w&#39;</span>)
<a name="l00177"></a>00177         <span class="keywordflow">for</span> l <span class="keywordflow">in</span> range(length):
<a name="l00178"></a>00178             aout.write(<span class="stringliteral">&#39;%s %s\n&#39;</span> % pedobj.pedigree[l].animalID,<span class="stringliteral">&#39;1&#39;</span>)
<a name="l00179"></a>00179         aout.close()
<a name="l00180"></a>00180         _r = 1
<a name="l00181"></a>00181     <span class="keywordflow">except</span>:
<a name="l00182"></a>00182         _r = 0
<a name="l00183"></a>00183     <span class="keywordflow">try</span>: logging.info(<span class="stringliteral">&#39;Exited dissertation_pedigree_to_pedig_interest_format()&#39;</span>)
<a name="l00184"></a>00184     <span class="keywordflow">except</span>: <span class="keywordflow">pass</span>
<a name="l00185"></a>00185     <span class="keywordflow">return</span> _r
<a name="l00186"></a>00186 
<a name="l00187"></a>00187 <span class="comment">##</span>
<a name="l00188"></a>00188 <span class="comment"># dissertation_pedigree_to_pedig_format_mask() Takes a pedigree in &#39;asdbxfg&#39; format,</span>
<a name="l00189"></a>00189 <span class="comment"># formats it into the form used by Didier Boichard&#39;s &#39;pedig&#39; suite of programs, and</span>
<a name="l00190"></a>00190 <span class="comment"># writes it to a file. THIS FUNCTION MASKS THE GENERATION ID WITH A FAKE BIRTH YEAR</span>
<a name="l00191"></a>00191 <span class="comment"># AND WRITES THE FAKE BIRTH YEAR TO THE FILE INSTEAD OF THE TRUE BIRTH YEAR. THIS IS</span>
<a name="l00192"></a>00192 <span class="comment"># AN ATTEMPT TO FOOL PEDIG TO GET f_e, f_a et al. BY GENERATION.</span>
<a name="l00193"></a>00193 <span class="comment"># @param pedobj A PyPedal pedigree object.</span>
<a name="l00194"></a>00194 <span class="comment"># @retval True (1) on success, false (0) on failure</span>
<a name="l00195"></a>00195 <span class="keyword">def </span>dissertation_pedigree_to_pedig_format_mask(pedobj):
<a name="l00196"></a>00196     <span class="stringliteral">&quot;&quot;&quot;</span>
<a name="l00197"></a>00197 <span class="stringliteral">    dissertation_pedigree_to_pedig_format_mask() Takes a pedigree in &#39;asdbxfg&#39; format,</span>
<a name="l00198"></a>00198 <span class="stringliteral">    formats it into the form used by Didier Boichard&#39;s &#39;pedig&#39; suite of programs, and</span>
<a name="l00199"></a>00199 <span class="stringliteral">    writes it to a file. THIS FUNCTION MASKS THE GENERATION ID WITH A FAKE BIRTH YEAR</span>
<a name="l00200"></a>00200 <span class="stringliteral">    AND WRITES THE FAKE BIRTH YEAR TO THE FILE INSTEAD OF THE TRUE BIRTH YEAR. THIS IS</span>
<a name="l00201"></a>00201 <span class="stringliteral">    AN ATTEMPT TO FOOL PEDIG TO GET f_e, f_a et al. BY GENERATION.</span>
<a name="l00202"></a>00202 <span class="stringliteral">    &quot;&quot;&quot;</span>
<a name="l00203"></a>00203     <span class="keywordflow">try</span>: logging.info(<span class="stringliteral">&#39;Entered dissertation_pedigree_to_pedig_format_mask()&#39;</span>)
<a name="l00204"></a>00204     <span class="keywordflow">except</span>: <span class="keywordflow">pass</span>
<a name="l00205"></a>00205     <span class="keywordflow">try</span>:
<a name="l00206"></a>00206         length = len(pedobj.pedigree)
<a name="l00207"></a>00207         outputfile = <span class="stringliteral">&#39;%s%s%s&#39;</span> % (pedobj.kw[<span class="stringliteral">&#39;filetag&#39;</span>],<span class="stringliteral">&#39;_pedig_mask&#39;</span>,<span class="stringliteral">&#39;.ped&#39;</span>)
<a name="l00208"></a>00208         aout = open(outputfile,<span class="stringliteral">&#39;w&#39;</span>)
<a name="l00209"></a>00209         <span class="keywordflow">for</span> l <span class="keywordflow">in</span> range(length):
<a name="l00210"></a>00210             <span class="comment">## mask generations (yes, this could be shorter - but this is easy to debug</span>
<a name="l00211"></a>00211             mygen = float(pedobj.pedigree[l].gen)
<a name="l00212"></a>00212             <span class="keywordflow">if</span> ( mygen &gt; 0 <span class="keywordflow">and</span> mygen &lt;= 1.25 ):         _gen = 10
<a name="l00213"></a>00213             <span class="keywordflow">elif</span> ( mygen &gt; 1.25 <span class="keywordflow">and</span> mygen &lt;= 1.75 ):    _gen = 15
<a name="l00214"></a>00214             <span class="keywordflow">elif</span> ( mygen &gt; 1.75 <span class="keywordflow">and</span> mygen &lt;= 2.25 ):    _gen = 20
<a name="l00215"></a>00215             <span class="keywordflow">elif</span> ( mygen &gt; 2.25 <span class="keywordflow">and</span> mygen &lt;= 2.75 ):    _gen = 25
<a name="l00216"></a>00216             <span class="keywordflow">elif</span> ( mygen &gt; 2.75 <span class="keywordflow">and</span> mygen &lt;= 3.25 ):    _gen = 30
<a name="l00217"></a>00217             <span class="keywordflow">elif</span> ( mygen &gt; 3.25 <span class="keywordflow">and</span> mygen &lt;= 3.75 ):    _gen = 35
<a name="l00218"></a>00218             <span class="keywordflow">elif</span> ( mygen &gt; 3.75 <span class="keywordflow">and</span> mygen &lt;= 4.25 ):    _gen = 40
<a name="l00219"></a>00219             <span class="keywordflow">elif</span> ( mygen &gt; 4.25 <span class="keywordflow">and</span> mygen &lt;= 4.75 ):    _gen = 45
<a name="l00220"></a>00220             <span class="keywordflow">elif</span> ( mygen &gt; 4.75 <span class="keywordflow">and</span> mygen &lt;= 5.25 ):    _gen = 50
<a name="l00221"></a>00221             <span class="keywordflow">elif</span> ( mygen &gt; 5.25 <span class="keywordflow">and</span> mygen &lt;= 5.75 ):    _gen = 55
<a name="l00222"></a>00222             <span class="keywordflow">elif</span> ( mygen &gt; 5.75 <span class="keywordflow">and</span> mygen &lt;= 6.25 ):    _gen = 60
<a name="l00223"></a>00223             <span class="keywordflow">elif</span> ( mygen &gt; 6.25 <span class="keywordflow">and</span> mygen &lt;= 6.75 ):    _gen = 65
<a name="l00224"></a>00224             <span class="keywordflow">elif</span> ( mygen &gt; 6.75 <span class="keywordflow">and</span> mygen &lt;= 7.25 ):    _gen = 70
<a name="l00225"></a>00225             <span class="keywordflow">elif</span> ( mygen &gt; 7.25 <span class="keywordflow">and</span> mygen &lt;= 7.75 ):    _gen = 75
<a name="l00226"></a>00226             <span class="keywordflow">else</span>:                                       _gen = 0
<a name="l00227"></a>00227             _maskgen = 1950 + _gen
<a name="l00228"></a>00228             <span class="comment">## convert sexes</span>
<a name="l00229"></a>00229             <span class="keywordflow">if</span> pedobj.pedigree[l].sex == <span class="stringliteral">&#39;m&#39;</span> <span class="keywordflow">or</span> pedobj.pedigree[l].sex == <span class="stringliteral">&#39;M&#39;</span>:
<a name="l00230"></a>00230                 sex = 1
<a name="l00231"></a>00231             <span class="keywordflow">else</span>:
<a name="l00232"></a>00232                 sex = 2
<a name="l00233"></a>00233             aout.write(<span class="stringliteral">&#39;%s %s %s %s %s %s %s\n&#39;</span> % pedobj.pedigree[l].animalID,pedobj.pedigree[l].sireID,pedobj.pedigree[l].damID,_maskgen,sex,<span class="stringliteral">&#39;1&#39;</span>,<span class="stringliteral">&#39;1&#39;</span>)
<a name="l00234"></a>00234         aout.close()
<a name="l00235"></a>00235         _r = 1
<a name="l00236"></a>00236     <span class="keywordflow">except</span>:
<a name="l00237"></a>00237         _r = 0
<a name="l00238"></a>00238     <span class="keywordflow">try</span>: logging.info(<span class="stringliteral">&#39;Exited dissertation_pedigree_to_pedig_format_mask()&#39;</span>)
<a name="l00239"></a>00239     <span class="keywordflow">except</span>: <span class="keywordflow">pass</span>
<a name="l00240"></a>00240     <span class="keywordflow">return</span> _r
<a name="l00241"></a>00241 
<a name="l00242"></a>00242 <span class="comment">##</span>
<a name="l00243"></a>00243 <span class="comment"># pyp_file_header() writes a header to a page of PyPedal output.</span>
<a name="l00244"></a>00244 <span class="comment"># @param ofhandle A Python file handle.</span>
<a name="l00245"></a>00245 <span class="comment"># @param caller A string indicating the name of the calling routine.</span>
<a name="l00246"></a>00246 <span class="comment"># @retval None</span>
<a name="l00247"></a>00247 <span class="keyword">def </span>pyp_file_header(ofhandle, caller=&quot;Unknown PyPedal routine&quot;):
<a name="l00248"></a>00248     <span class="stringliteral">&quot;&quot;&quot;</span>
<a name="l00249"></a>00249 <span class="stringliteral">    pyp_file_header() writes a header to a page of PyPedal output.</span>
<a name="l00250"></a>00250 <span class="stringliteral">    &quot;&quot;&quot;</span>
<a name="l00251"></a>00251     <span class="keywordflow">try</span>:
<a name="l00252"></a>00252         ofhandle.write(<span class="stringliteral">&#39;%s\n&#39;</span> % (<span class="stringliteral">&#39;-&#39;</span>*80))
<a name="l00253"></a>00253         ofhandle.write(<span class="stringliteral">&#39;Created by %s at %s\n&#39;</span> % (caller,pyp_utils.pyp_nice_time()))
<a name="l00254"></a>00254         ofhandle.write(<span class="stringliteral">&#39;%s\n&#39;</span> % (<span class="stringliteral">&#39;-&#39;</span>*80))
<a name="l00255"></a>00255     <span class="keywordflow">except</span>:
<a name="l00256"></a>00256         <span class="keywordflow">pass</span>
<a name="l00257"></a>00257 
<a name="l00258"></a>00258 <span class="comment">##</span>
<a name="l00259"></a>00259 <span class="comment"># pyp_file_footer() writes a footer to a page of PyPedal output.</span>
<a name="l00260"></a>00260 <span class="comment"># @param ofhandle A Python file handle.</span>
<a name="l00261"></a>00261 <span class="comment"># @param caller A string indicating the name of the calling routine.</span>
<a name="l00262"></a>00262 <span class="comment"># @retval None</span>
<a name="l00263"></a>00263 <span class="keyword">def </span>pyp_file_footer(ofhandle, caller=&quot;Unknown PyPedal routine&quot;):
<a name="l00264"></a>00264     <span class="stringliteral">&quot;&quot;&quot;</span>
<a name="l00265"></a>00265 <span class="stringliteral">    pyp_file_footer() writes a footer to a page of PyPedal output.</span>
<a name="l00266"></a>00266 <span class="stringliteral">    &quot;&quot;&quot;</span>
<a name="l00267"></a>00267     <span class="keywordflow">try</span>:
<a name="l00268"></a>00268         ofhandle.write(<span class="stringliteral">&#39;%s\n&#39;</span> % (<span class="stringliteral">&#39;-&#39;</span>*80))
<a name="l00269"></a>00269     <span class="keywordflow">except</span>:
<a name="l00270"></a>00270         <span class="keywordflow">pass</span>
<a name="l00271"></a>00271 
<a name="l00272"></a>00272 <span class="comment">##</span>
<a name="l00273"></a>00273 <span class="comment"># renderTitle() renders page titles (produces HTML output by default).</span>
<a name="l00274"></a>00274 <span class="comment"># @param title_string String to be enclosed in HTML &quot;H&quot; tags</span>
<a name="l00275"></a>00275 <span class="comment"># @param title_level Size to be attached to &quot;H&quot; tags, e.g., &quot;H1&quot;</span>
<a name="l00276"></a>00276 <span class="comment"># @retval None</span>
<a name="l00277"></a>00277 <span class="keyword">def </span>renderTitle(title_string, title_level=&quot;1&quot;):
<a name="l00278"></a>00278     <span class="stringliteral">&quot;&quot;&quot;</span>
<a name="l00279"></a>00279 <span class="stringliteral">    renderTitle() renders page titles (produces HTML output by default).</span>
<a name="l00280"></a>00280 <span class="stringliteral">    &quot;&quot;&quot;</span>
<a name="l00281"></a>00281     <span class="keywordflow">if</span> <span class="keywordflow">not</span> PYPEDAL_OUTPUT_TYPE:
<a name="l00282"></a>00282         PYPEDAL_OUTPUT_TYPE = <span class="stringliteral">&#39;html&#39;</span>
<a name="l00283"></a>00283     <span class="comment"># We are trying to keep it simple here.</span>
<a name="l00284"></a>00284     <span class="keywordflow">if</span> ( <span class="keywordflow">not</span> title_level ) <span class="keywordflow">or</span> ( title_level &lt; 1 ) <span class="keywordflow">or</span> ( title_level &gt; 3 ):
<a name="l00285"></a>00285         title_level = 1
<a name="l00286"></a>00286     <span class="keywordflow">if</span> PYPEDAL_OUTPUT_TYPE == <span class="stringliteral">&#39;h&#39;</span>:
<a name="l00287"></a>00287         renderedTitle = <span class="stringliteral">&#39;&lt;H%s&gt;%s&lt;/H%s&gt;\n&#39;</span> % (title_level,title_string,title_level)
<a name="l00288"></a>00288     <span class="keywordflow">else</span>:
<a name="l00289"></a>00289         _underline = <span class="stringliteral">&#39;=&#39;</span>*len(title_string)
<a name="l00290"></a>00290         renderedTitle = <span class="stringliteral">&#39;%s\n&#39;</span> % (title_string,_underline)
<a name="l00291"></a>00291     <span class="keywordflow">return</span> renderedTitle
<a name="l00292"></a>00292 
<a name="l00293"></a>00293 <span class="comment">##</span>
<a name="l00294"></a>00294 <span class="comment"># renderBodyText() renders page contents (produces HTML output by default).</span>
<a name="l00295"></a>00295 <span class="comment"># @param text_string String to be rendered with either a trailing newline or enclosed in HTNL &quot;P&quot; tags</span>
<a name="l00296"></a>00296 <span class="comment"># @retval None</span>
<a name="l00297"></a>00297 <span class="keyword">def </span>renderBodyText(text_string):
<a name="l00298"></a>00298     <span class="stringliteral">&quot;&quot;&quot;</span>
<a name="l00299"></a>00299 <span class="stringliteral">    renderBodyText() renders page contents (produces HTML output by default).</span>
<a name="l00300"></a>00300 <span class="stringliteral">    &quot;&quot;&quot;</span>
<a name="l00301"></a>00301     <span class="keywordflow">if</span> <span class="keywordflow">not</span> PYPEDAL_OUTPUT_TYPE:
<a name="l00302"></a>00302         PYPEDAL_OUTPUT_TYPE = <span class="stringliteral">&#39;html&#39;</span>
<a name="l00303"></a>00303     <span class="keywordflow">if</span> PYPEDAL_OUTPUT_TYPE == <span class="stringliteral">&#39;h&#39;</span>:
<a name="l00304"></a>00304         renderedBodyText = <span class="stringliteral">&#39;&lt;p&gt;%s&lt;/p&gt;&#39;</span> % (text_string)
<a name="l00305"></a>00305     <span class="keywordflow">else</span>:
<a name="l00306"></a>00306         renderedBodyText = <span class="stringliteral">&#39;%s\n&#39;</span> % (text_string)
<a name="l00307"></a>00307     <span class="keywordflow">return</span> renderedBodyText
<a name="l00308"></a>00308 
<a name="l00309"></a>00309 <span class="comment">##</span>
<a name="l00310"></a>00310 <span class="comment"># pickle_pedigree() pickles a pedigree.</span>
<a name="l00311"></a>00311 <span class="comment"># @param pedobj An instance of a PyPedal pedigree object.</span>
<a name="l00312"></a>00312 <span class="comment"># @param filename The name of the file to which the pedigree object should be pickled (optional).</span>
<a name="l00313"></a>00313 <span class="comment"># @retval A 1 on success, a 0 otherwise.</span>
<a name="l00314"></a>00314 <span class="keyword">def </span>pickle_pedigree(pedobj, filename=&#39;&#39;):
<a name="l00315"></a>00315     <span class="stringliteral">&quot;&quot;&quot;</span>
<a name="l00316"></a>00316 <span class="stringliteral">    pickle_pedigree() pickles a pedigree.</span>
<a name="l00317"></a>00317 <span class="stringliteral">    &quot;&quot;&quot;</span>
<a name="l00318"></a>00318     <span class="keywordflow">try</span>: logging.info(<span class="stringliteral">&#39;Entered pickle_pedigree()&#39;</span>)
<a name="l00319"></a>00319     <span class="keywordflow">except</span>: <span class="keywordflow">pass</span>
<a name="l00320"></a>00320     <span class="keywordflow">try</span>:
<a name="l00321"></a>00321         _r = 1
<a name="l00322"></a>00322         <span class="keywordflow">if</span> <span class="keywordflow">not</span> filename:
<a name="l00323"></a>00323           _pfn = <span class="stringliteral">&#39;%s.pkl&#39;</span> % ( pedobj.kw[<span class="stringliteral">&#39;filetag&#39;</span>] )
<a name="l00324"></a>00324         <span class="keywordflow">else</span>:
<a name="l00325"></a>00325             _pfn = <span class="stringliteral">&#39;%s.pkl&#39;</span> % ( filename )
<a name="l00326"></a>00326         <span class="keywordflow">print</span> _pfn
<a name="l00327"></a>00327         pickle.dump(pedobj,open(_pfn,<span class="stringliteral">&#39;w&#39;</span>))
<a name="l00328"></a>00328         logging.info(<span class="stringliteral">&#39;Pickled pedigree %s to file %s&#39;</span>, pedobj.kw[<span class="stringliteral">&#39;pedname&#39;</span>], _pfn )
<a name="l00329"></a>00329         <span class="keywordflow">if</span> pedobj.kw[<span class="stringliteral">&#39;messages&#39;</span>] == <span class="stringliteral">&#39;verbose&#39;</span>:
<a name="l00330"></a>00330             <span class="keywordflow">print</span> <span class="stringliteral">&#39;Pickled pedigree %s to file %s&#39;</span> % ( pedobj.kw[<span class="stringliteral">&#39;pedname&#39;</span>], _pfn )
<a name="l00331"></a>00331     <span class="keywordflow">except</span>:
<a name="l00332"></a>00332         logging.error(<span class="stringliteral">&#39;Unable to pickle pedigree %s to file %s&#39;</span>, self.kw[<span class="stringliteral">&#39;pedname&#39;</span>], _pfn )
<a name="l00333"></a>00333         _r = 0
<a name="l00334"></a>00334     <span class="keywordflow">try</span>: logging.info(<span class="stringliteral">&#39;Exited pickle_pedigree()&#39;</span>)
<a name="l00335"></a>00335     <span class="keywordflow">except</span>: <span class="keywordflow">pass</span>
<a name="l00336"></a>00336     <span class="keywordflow">return</span> _r
<a name="l00337"></a>00337 
<a name="l00338"></a>00338 <span class="comment">##</span>
<a name="l00339"></a>00339 <span class="comment"># unpickle_pedigree() reads a pickled pedigree in from a file and returns the unpacked</span>
<a name="l00340"></a>00340 <span class="comment"># pedigree object.</span>
<a name="l00341"></a>00341 <span class="comment"># @param filename The name of the pickle file.</span>
<a name="l00342"></a>00342 <span class="comment"># @retval An instance of a NewPedigree object on success, a 0 otherwise.</span>
<a name="l00343"></a>00343 <span class="keyword">def </span>unpickle_pedigree(filename=&#39;&#39;):
<a name="l00344"></a>00344     <span class="stringliteral">&quot;&quot;&quot;</span>
<a name="l00345"></a>00345 <span class="stringliteral">    unpickle_pedigree() reads a pickled pedigree in from a file and returns the unpacked</span>
<a name="l00346"></a>00346 <span class="stringliteral">    pedigree object.</span>
<a name="l00347"></a>00347 <span class="stringliteral">    &quot;&quot;&quot;</span>
<a name="l00348"></a>00348     <span class="keywordflow">try</span>: logging.info(<span class="stringliteral">&#39;Entered unpickle_pedigree()&#39;</span>)
<a name="l00349"></a>00349     <span class="keywordflow">except</span>: <span class="keywordflow">pass</span>
<a name="l00350"></a>00350     <span class="keywordflow">try</span>:
<a name="l00351"></a>00351         <span class="keywordflow">if</span> <span class="keywordflow">not</span> filename:
<a name="l00352"></a>00352             logging.error(<span class="stringliteral">&#39;No filename provided for pedigree unpickling!&#39;</span> )
<a name="l00353"></a>00353             _r = 0
<a name="l00354"></a>00354         <span class="keywordflow">else</span>:
<a name="l00355"></a>00355             _ck_pfn = string.split(filename,<span class="stringliteral">&#39;.&#39;</span>)
<a name="l00356"></a>00356             <span class="keywordflow">if</span> len(_ck_pfn) == 2:
<a name="l00357"></a>00357                 _pfn = filename
<a name="l00358"></a>00358             <span class="keywordflow">else</span>:
<a name="l00359"></a>00359                 _pfn = <span class="stringliteral">&#39;%s.pkl&#39;</span> % ( filename )
<a name="l00360"></a>00360                 logging.info(<span class="stringliteral">&#39;No file extension provided for %s.  An extension (.pkl) was added.&#39;</span>, filename )
<a name="l00361"></a>00361             _myped = pickle.load(open(_pfn))
<a name="l00362"></a>00362             logging.info(<span class="stringliteral">&#39;Unpickled pedigree %s from file %s&#39;</span>, _myped.kw[<span class="stringliteral">&#39;pedname&#39;</span>], _pfn )
<a name="l00363"></a>00363             _r = _myped
<a name="l00364"></a>00364     <span class="keywordflow">except</span>:
<a name="l00365"></a>00365         logging.error(<span class="stringliteral">&#39;Unable to unpickle pedigree from file!&#39;</span> )
<a name="l00366"></a>00366         _r = 0
<a name="l00367"></a>00367     <span class="keywordflow">try</span>: logging.info(<span class="stringliteral">&#39;Exited unpickle_pedigree()&#39;</span>)
<a name="l00368"></a>00368     <span class="keywordflow">except</span>: <span class="keywordflow">pass</span>
<a name="l00369"></a>00369     <span class="keywordflow">return</span> _r
<a name="l00370"></a>00370 
<a name="l00371"></a>00371 <span class="comment">##</span>
<a name="l00372"></a>00372 <span class="comment"># summary_inbreeding() returns a string representation of the data contained in</span>
<a name="l00373"></a>00373 <span class="comment"># the &#39;metadata&#39; dictionary contained in the output dictionary returned by</span>
<a name="l00374"></a>00374 <span class="comment"># pyp_nrm/pyp_inbreeding().</span>
<a name="l00375"></a>00375 <span class="comment"># @param f_metadata Dictionary of inbreeding metadata.</span>
<a name="l00376"></a>00376 <span class="comment"># @retval A string on success, a 0 otherwise.</span>
<a name="l00377"></a>00377 <span class="keyword">def </span>summary_inbreeding(f_metadata):
<a name="l00378"></a>00378     <span class="stringliteral">&quot;&quot;&quot;</span>
<a name="l00379"></a>00379 <span class="stringliteral">    summary_inbreeding() returns a string representation of the data contained in</span>
<a name="l00380"></a>00380 <span class="stringliteral">    the &#39;metadata&#39; dictionary contained in the output dictionary returned by</span>
<a name="l00381"></a>00381 <span class="stringliteral">    pyp_nrm/pyp_inbreeding().</span>
<a name="l00382"></a>00382 <span class="stringliteral">    &quot;&quot;&quot;</span>
<a name="l00383"></a>00383     <span class="keywordflow">try</span>:
<a name="l00384"></a>00384         _summary = <span class="stringliteral">&#39;&#39;</span>
<a name="l00385"></a>00385         _summary = <span class="stringliteral">&#39;%s&#39;</span> % (LINE1)
<a name="l00386"></a>00386         _summary = <span class="stringliteral">&#39;%s\n%s&#39;</span> % (_summary, <span class="stringliteral">&#39;Inbreeding Statistics&#39;</span>)
<a name="l00387"></a>00387         _summary = <span class="stringliteral">&#39;\n%s\n%s&#39;</span> % (_summary, LINE1)
<a name="l00388"></a>00388         _summary = <span class="stringliteral">&#39;%s\n%s&#39;</span> % (_summary, <span class="stringliteral">&#39;All animals:&#39;</span>)
<a name="l00389"></a>00389         _summary = <span class="stringliteral">&#39;\n%s\n%s&#39;</span> % (_summary, LINE2)
<a name="l00390"></a>00390         <span class="keywordflow">for</span> k,v <span class="keywordflow">in</span> f_metadata[<span class="stringliteral">&#39;all&#39;</span>].iteritems():
<a name="l00391"></a>00391             _line = <span class="stringliteral">&#39;\t%s\t%s&#39;</span> % (k,v)
<a name="l00392"></a>00392             _summary = <span class="stringliteral">&#39;%s\n%s&#39;</span> % (_summary, _line)
<a name="l00393"></a>00393         _summary = <span class="stringliteral">&#39;\n%s\n%s&#39;</span> % (_summary, LINE1)
<a name="l00394"></a>00394         _summary = <span class="stringliteral">&#39;%s\n%s&#39;</span> % (_summary, <span class="stringliteral">&#39;Animals with non-zero CoI:&#39;</span>)
<a name="l00395"></a>00395         _summary = <span class="stringliteral">&#39;\n%s\n%s&#39;</span> % (_summary, LINE2)
<a name="l00396"></a>00396         <span class="keywordflow">for</span> k,v <span class="keywordflow">in</span> f_metadata[<span class="stringliteral">&#39;nonzero&#39;</span>].iteritems():
<a name="l00397"></a>00397             _line = <span class="stringliteral">&#39;\t%s\t%s&#39;</span> % (k,v)
<a name="l00398"></a>00398             _summary = <span class="stringliteral">&#39;%s\n%s&#39;</span> % (_summary, _line)
<a name="l00399"></a>00399         _summary = <span class="stringliteral">&#39;\n%s\n%s&#39;</span> % (_summary, LINE1)
<a name="l00400"></a>00400         <span class="keywordflow">return</span> _summary
<a name="l00401"></a>00401     <span class="keywordflow">except</span>:
<a name="l00402"></a>00402         <span class="keywordflow">return</span> <span class="stringliteral">&#39;0&#39;</span>
<a name="l00403"></a>00403 
<a name="l00404"></a>00404 <span class="comment">##</span>
<a name="l00405"></a>00405 <span class="comment"># save_ijk() saves an NRM to a file in the form &quot;animal A&quot; &quot;animal B&quot; &quot;rAB&quot;.</span>
<a name="l00406"></a>00406 <span class="comment"># @param pedobj: The pedigree to which the NRM is attached</span>
<a name="l00407"></a>00407 <span class="comment"># @param nrm_filename: The file to which the matrix should be written.</span>
<a name="l00408"></a>00408 <span class="comment"># @retval A save status indicator (0: failed, 1: success).</span>
<a name="l00409"></a>00409 <span class="keyword">def </span>save_ijk(pedobj, nrm_filename):
<a name="l00410"></a>00410     <span class="stringliteral">&quot;&quot;&quot;</span>
<a name="l00411"></a>00411 <span class="stringliteral">    save_ijk() saves an NRM to a file in the form &quot;animal A&quot; &quot;animal B&quot; &quot;rAB&quot;.</span>
<a name="l00412"></a>00412 <span class="stringliteral">    &quot;&quot;&quot;</span>
<a name="l00413"></a>00413     <span class="keywordflow">if</span> pedobj.kw[<span class="stringliteral">&#39;messages&#39;</span>] == <span class="stringliteral">&#39;verbose&#39;</span>:
<a name="l00414"></a>00414         <span class="keywordflow">print</span> <span class="stringliteral">&#39;[INFO]: Saving A-matrix to file %s at %s.&#39;</span> % ( nrm_filename, pyp_utils.pyp_nice_time() )
<a name="l00415"></a>00415     logging.info(<span class="stringliteral">&#39;Saving A-matrix to file %s&#39;</span>, nrm_filename)
<a name="l00416"></a>00416     <span class="comment">#try:</span>
<a name="l00417"></a>00417     of = file(nrm_filename,<span class="stringliteral">&quot;w&quot;</span>)
<a name="l00418"></a>00418     <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(pedobj.metadata.num_records):
<a name="l00419"></a>00419         <span class="keywordflow">for</span> j <span class="keywordflow">in</span> range(i,pedobj.metadata.num_records):
<a name="l00420"></a>00420             line = <span class="stringliteral">&#39;%s %s %s\n&#39;</span> % ( pedobj.backmap[i+1], pedobj.backmap[j+1], pedobj.nrm.nrm[i,j])
<a name="l00421"></a>00421             of.write(line)
<a name="l00422"></a>00422     of.close()
<a name="l00423"></a>00423     <span class="keywordflow">if</span> pedobj.kw[<span class="stringliteral">&#39;messages&#39;</span>] == <span class="stringliteral">&#39;verbose&#39;</span>:
<a name="l00424"></a>00424         <span class="keywordflow">print</span> <span class="stringliteral">&#39;[INFO]: A-matrix successfully saved to file %s at %s.&#39;</span> % ( nrm_filename, pyp_utils.pyp_nice_time() )
<a name="l00425"></a>00425     logging.info(<span class="stringliteral">&#39;A-matrix successfully saved to file %s&#39;</span>, nrm_filename)
<a name="l00426"></a>00426     <span class="keywordflow">return</span> 1
<a name="l00427"></a>00427 
<a name="l00428"></a>00428 <span class="comment">##</span>
<a name="l00429"></a>00429 <span class="comment"># load_from_gedcom() reads and parses pedigree data that conform to</span>
<a name="l00430"></a>00430 <span class="comment"># a subset of the GEDCOM 5.5 specification. Not all valid GEDCOM</span>
<a name="l00431"></a>00431 <span class="comment"># are supported; unsupported tags are ignored.</span>
<a name="l00432"></a>00432 <span class="comment"># @param infilename The file to which the matrix should be written.</span>
<a name="l00433"></a>00433 <span class="comment"># @param messages Controls output to the screen</span>
<a name="l00434"></a>00434 <span class="comment"># @param standalone Uses logging if called by a NewPedigree method</span>
<a name="l00435"></a>00435 <span class="comment"># @param missing_sex Value assigned to an animal with unknown sex</span>
<a name="l00436"></a>00436 <span class="comment"># @param missing_parent Value assigned to unknown parents</span>
<a name="l00437"></a>00437 <span class="comment"># @param missing_name Name assigned by default</span>
<a name="l00438"></a>00438 <span class="comment"># @param missing_byear VAlue assigned to unknown birth years</span>
<a name="l00439"></a>00439 <span class="comment"># @param debug Flag turning debugging messages on (1) and off (0)</span>
<a name="l00440"></a>00440 <span class="comment"># @retval A save status indicator (0: failed, 1: success).</span>
<a name="l00441"></a>00441 <span class="keyword">def </span>load_from_gedcom(infilename, messages=&#39;verbose&#39;, standalone=1, missing_sex=&#39;u&#39;, \
<a name="l00442"></a>00442     missing_parent=0, missing_name=<span class="stringliteral">&#39;Unknown Name&#39;</span>, missing_byear=<span class="stringliteral">&#39;0001&#39;</span>, debug=0):
<a name="l00443"></a>00443     <span class="stringliteral">&quot;&quot;&quot;</span>
<a name="l00444"></a>00444 <span class="stringliteral">    load_from_gedcom() reads and parses pedigree data that conform to</span>
<a name="l00445"></a>00445 <span class="stringliteral">    a subset of the GEDCOM 5.5 specification. Not all valid GEDCOM</span>
<a name="l00446"></a>00446 <span class="stringliteral">    are supported; unsupported tags are ignored.</span>
<a name="l00447"></a>00447 <span class="stringliteral">    &quot;&quot;&quot;</span>
<a name="l00448"></a>00448 
<a name="l00449"></a>00449     <span class="comment"># NOTE: There is a lot of error-checking that could be done here but isn&#39;t. That</span>
<a name="l00450"></a>00450     <span class="comment"># behavior is a deliberate design decision. load_from_gedcom() is NOT intended to</span>
<a name="l00451"></a>00451     <span class="comment"># be a general-purpose GEDCOM parser, but rather is supposed to convert a GEDCOM</span>
<a name="l00452"></a>00452     <span class="comment"># file into a pedigree format that PyPedal can load into a NewPedigree object with</span>
<a name="l00453"></a>00453     <span class="comment"># no trouble. The error-checking and related operations, such as automatically adding</span>
<a name="l00454"></a>00454     <span class="comment"># pedigree entries for parents with no records themselves, are left to the preprocess()</span>
<a name="l00455"></a>00455     <span class="comment"># and load() methods of the NewPedigree and NewAnimal classes.</span>
<a name="l00456"></a>00456     <span class="comment">#</span>
<a name="l00457"></a>00457     <span class="comment"># If someone wants to take this function and extend it to be more general that&#39;s fine,</span>
<a name="l00458"></a>00458     <span class="comment"># but I ask that they create a new function that extends this function rather than</span>
<a name="l00459"></a>00459     <span class="comment"># altering the no-doubt imperfect behavior of load_from_gedcom().</span>
<a name="l00460"></a>00460     known_tags = [<span class="stringliteral">&#39;BIRT&#39;</span>,<span class="stringliteral">&#39;CHIL&#39;</span>,<span class="stringliteral">&#39;DATE&#39;</span>,<span class="stringliteral">&#39;FAM&#39;</span>,<span class="stringliteral">&#39;FAMC&#39;</span>,<span class="stringliteral">&#39;FAMS&#39;</span>,<span class="stringliteral">&#39;HUSB&#39;</span>, \
<a name="l00461"></a>00461         <span class="stringliteral">&#39;INDI&#39;</span>,<span class="stringliteral">&#39;NAME&#39;</span>,<span class="stringliteral">&#39;SEX&#39;</span>,<span class="stringliteral">&#39;WIFE&#39;</span>]
<a name="l00462"></a>00462     current_level, any_names, any_sexes, any_birth, get_birth = 0, 0, 0, 0, 0
<a name="l00463"></a>00463     indi, fam = {}, {}
<a name="l00464"></a>00464     <span class="comment"># Structures for mapping data</span>
<a name="l00465"></a>00465     fam2husb, fam2wife, fam2chil, indi2name, indi2sex, indi2famc, indi2fams, indi2birth = {}, {}, {}, {}, {}, {}, {}, {}
<a name="l00466"></a>00466     <span class="comment"># Read the file</span>
<a name="l00467"></a>00467     <span class="keywordflow">if</span> standalone == 0: logging.info(<span class="stringliteral">&#39;[load_from_gedcom]: Opening GEDCOM pedigree file %s.&#39;</span>,infilename)
<a name="l00468"></a>00468     infile = open(infilename,<span class="stringliteral">&#39;</span><span class="stringliteral">r&#39;)</span>
<a name="l00469"></a>00469 <span class="stringliteral">    inlines = infile.readlines()</span>
<a name="l00470"></a>00470 <span class="stringliteral">    infile.close()</span>
<a name="l00471"></a>00471 <span class="stringliteral">    all_done = 0  </span><span class="comment"># Have we processed all of the input lines?</span>
<a name="l00472"></a>00472     next_zero = 0 <span class="comment"># Have we seen the next zero?</span>
<a name="l00473"></a>00473     zero_mark = 0 <span class="comment"># If so, where?</span>
<a name="l00474"></a>00474     last_round = 0
<a name="l00475"></a>00475 
<a name="l00476"></a>00476     <span class="keywordflow">try</span>:
<a name="l00477"></a>00477         <span class="keywordflow">while</span> <span class="keywordflow">not</span> all_done:
<a name="l00478"></a>00478             next_zero = 0
<a name="l00479"></a>00479             _curr_rec = []
<a name="l00480"></a>00480             <span class="keywordflow">for</span> l <span class="keywordflow">in</span> xrange(zero_mark,len(inlines)+1):
<a name="l00481"></a>00481                 <span class="comment"># I don&#39;t think that all GEDCOM 5.5 0-level records contain three tokens, but</span>
<a name="l00482"></a>00482                 <span class="comment"># the INDI and FAM records do, and those are the records we want.</span>
<a name="l00483"></a>00483                 <span class="keywordflow">try</span>:
<a name="l00484"></a>00484                     linelist = inlines[l].strip().split(<span class="stringliteral">&#39; &#39;</span>)
<a name="l00485"></a>00485                     <span class="keywordflow">if</span> len(linelist) &gt; 1:
<a name="l00486"></a>00486                         <span class="keywordflow">if</span> linelist[0] == <span class="stringliteral">&#39;0&#39;</span> <span class="keywordflow">and</span> l &gt; zero_mark:
<a name="l00487"></a>00487                             next_zero = 1
<a name="l00488"></a>00488                             zero_mark = l
<a name="l00489"></a>00489                             <span class="keywordflow">break</span>
<a name="l00490"></a>00490                         <span class="keywordflow">else</span>:
<a name="l00491"></a>00491                             _curr_rec.append(inlines[l])
<a name="l00492"></a>00492                 <span class="keywordflow">except</span> IndexError:
<a name="l00493"></a>00493                     all_done = 1
<a name="l00494"></a>00494             <span class="keywordflow">if</span> messages == <span class="stringliteral">&#39;debug&#39;</span>:
<a name="l00495"></a>00495                 <span class="keywordflow">print</span> <span class="stringliteral">&#39;-&#39;</span>*80
<a name="l00496"></a>00496                 <span class="keywordflow">print</span> _curr_rec
<a name="l00497"></a>00497                 <span class="keywordflow">print</span> <span class="stringliteral">&#39;-&#39;</span>*80
<a name="l00498"></a>00498             firstlinelist = _curr_rec[0].strip().rstrip(<span class="stringliteral">&#39;\r&#39;</span>).rstrip(<span class="stringliteral">&#39;\n&#39;</span>).split(<span class="stringliteral">&#39; &#39;</span>)
<a name="l00499"></a>00499             <span class="keywordflow">if</span> firstlinelist[-1] == <span class="stringliteral">&#39;INDI&#39;</span>:
<a name="l00500"></a>00500                 _tag, _name, _sex, _famc, _fams, _byr = 0, 0, 0, 0, [], 0
<a name="l00501"></a>00501                 any_sexes, any_birth, get_birth = 0, 0, 0
<a name="l00502"></a>00502                 <span class="keywordflow">for</span> c <span class="keywordflow">in</span> xrange(1,len(_curr_rec)):
<a name="l00503"></a>00503                     linelist = _curr_rec[c].strip().rstrip(<span class="stringliteral">&#39;\r&#39;</span>).rstrip(<span class="stringliteral">&#39;\n&#39;</span>).split(<span class="stringliteral">&#39; &#39;</span>)
<a name="l00504"></a>00504                     <span class="keywordflow">if</span> c == 1:
<a name="l00505"></a>00505                         _indi = _curr_rec[0].strip().split(<span class="stringliteral">&#39; &#39;</span>)[1][1:-1]
<a name="l00506"></a>00506                     <span class="keywordflow">if</span> len(linelist) &gt; 1:
<a name="l00507"></a>00507                         _tag = linelist[1].upper()
<a name="l00508"></a>00508                     <span class="keywordflow">else</span>: <span class="keywordflow">break</span>
<a name="l00509"></a>00509                     <span class="keywordflow">if</span> _tag <span class="keywordflow">in</span> known_tags:
<a name="l00510"></a>00510                         <span class="keywordflow">if</span> messages == <span class="stringliteral">&#39;debug&#39;</span>:
<a name="l00511"></a>00511                             <span class="keywordflow">print</span> <span class="stringliteral">&#39;Processing tag %s&#39;</span> % ( _tag )
<a name="l00512"></a>00512                         <span class="keywordflow">if</span> _tag.upper() == <span class="stringliteral">&#39;NAME&#39;</span>:
<a name="l00513"></a>00513                             _name =  <span class="stringliteral">&#39; &#39;</span>.join(linelist[2:])
<a name="l00514"></a>00514                         <span class="keywordflow">elif</span> _tag.upper() == <span class="stringliteral">&#39;SEX&#39;</span>:
<a name="l00515"></a>00515                             _sex =  linelist[2]
<a name="l00516"></a>00516                             any_sexes = 1
<a name="l00517"></a>00517                         <span class="keywordflow">elif</span> _tag.upper() == <span class="stringliteral">&#39;FAMC&#39;</span>:
<a name="l00518"></a>00518                             _famc = linelist[2][1:-1]
<a name="l00519"></a>00519                         <span class="keywordflow">elif</span> _tag.upper() == <span class="stringliteral">&#39;FAMS&#39;</span>:
<a name="l00520"></a>00520                             _fams.append(linelist[2][1:-1])
<a name="l00521"></a>00521                         <span class="comment"># The only dates handled right now are birth dates</span>
<a name="l00522"></a>00522                         <span class="keywordflow">elif</span> _tag.upper() == <span class="stringliteral">&#39;BIRT&#39;</span>:
<a name="l00523"></a>00523                             get_birth = 1
<a name="l00524"></a>00524                         <span class="keywordflow">elif</span> _tag.upper() == <span class="stringliteral">&#39;DATE&#39;</span> <span class="keywordflow">and</span> get_birth:
<a name="l00525"></a>00525                             _byr = <span class="stringliteral">&#39; &#39;</span>.join(linelist[2:])[-4:]
<a name="l00526"></a>00526                             get_birth = 0
<a name="l00527"></a>00527                             any_birth = 1
<a name="l00528"></a>00528                         <span class="keywordflow">else</span>: <span class="keywordflow">pass</span>
<a name="l00529"></a>00529                     <span class="keywordflow">else</span>:
<a name="l00530"></a>00530                         <span class="keywordflow">if</span> messages == <span class="stringliteral">&#39;debug&#39;</span>:
<a name="l00531"></a>00531                             <span class="keywordflow">print</span> <span class="stringliteral">&#39;Skipping unknown tag %s&#39;</span> % ( _tag )
<a name="l00532"></a>00532                     <span class="comment"># Once we&#39;ve read the entire record we can process the data.</span>
<a name="l00533"></a>00533                     <span class="comment"># Here&#39;s the basic idea: put the details from the INDI and</span>
<a name="l00534"></a>00534                     <span class="comment"># FAM records into dictionaries (lookup tables) as we sweep</span>
<a name="l00535"></a>00535                     <span class="comment"># the input data. Once we&#39;ve done that we&#39;ll assemble the</span>
<a name="l00536"></a>00536                     <span class="comment"># complete animal records from the pieces in the relevant</span>
<a name="l00537"></a>00537                     <span class="comment"># lookup tables.</span>
<a name="l00538"></a>00538                     <span class="keywordflow">if</span> c == len(_curr_rec)-1:
<a name="l00539"></a>00539                         <span class="keywordflow">if</span> <span class="keywordflow">not</span> any_sexes:
<a name="l00540"></a>00540                             _sex = missing_sex.upper()
<a name="l00541"></a>00541                         indi2sex[_indi] = _sex
<a name="l00542"></a>00542                         <span class="keywordflow">if</span> _byr:
<a name="l00543"></a>00543                             indi2birth[_indi] = _byr
<a name="l00544"></a>00544                         <span class="keywordflow">else</span>:
<a name="l00545"></a>00545                             indi2birth[_indi] = missing_byear
<a name="l00546"></a>00546                         <span class="keywordflow">if</span> _famc:
<a name="l00547"></a>00547                             indi2famc[_indi] = _famc
<a name="l00548"></a>00548                         <span class="keywordflow">if</span> _fams:
<a name="l00549"></a>00549                             indi2fams[_indi] = _fams
<a name="l00550"></a>00550                         <span class="keywordflow">if</span> <span class="stringliteral">&#39;_name&#39;</span>:
<a name="l00551"></a>00551                             <span class="keywordflow">if</span> <span class="keywordflow">not</span> any_names: any_names = 1
<a name="l00552"></a>00552                             indi2name[_indi] = _name
<a name="l00553"></a>00553                         <span class="keywordflow">else</span>:
<a name="l00554"></a>00554                             id2name[_id] = missing_name
<a name="l00555"></a>00555             <span class="keywordflow">elif</span> firstlinelist[-1] == <span class="stringliteral">&#39;FAM&#39;</span>:
<a name="l00556"></a>00556                 _husb, _wife,_child = 0, 0, []
<a name="l00557"></a>00557                 end_family = 0
<a name="l00558"></a>00558                 <span class="keywordflow">for</span> c <span class="keywordflow">in</span> xrange(1,len(_curr_rec)):
<a name="l00559"></a>00559                     linelist = _curr_rec[c].strip().rstrip(<span class="stringliteral">&#39;\r&#39;</span>).rstrip(<span class="stringliteral">&#39;\n&#39;</span>).split(<span class="stringliteral">&#39; &#39;</span>)
<a name="l00560"></a>00560                     <span class="keywordflow">if</span> c == 1:
<a name="l00561"></a>00561                         _fam = _curr_rec[0].strip().split(<span class="stringliteral">&#39; &#39;</span>)[1][1:-1]
<a name="l00562"></a>00562                     <span class="keywordflow">if</span> len(linelist) &gt; 1:
<a name="l00563"></a>00563                         _tag = linelist[1].upper()
<a name="l00564"></a>00564                     <span class="keywordflow">else</span>: <span class="keywordflow">break</span>
<a name="l00565"></a>00565                     <span class="keywordflow">if</span> _tag <span class="keywordflow">in</span> known_tags:
<a name="l00566"></a>00566                         <span class="keywordflow">if</span> messages == <span class="stringliteral">&#39;debug&#39;</span>:
<a name="l00567"></a>00567                             <span class="keywordflow">print</span> <span class="stringliteral">&#39;Processing tag %s&#39;</span> % ( _tag )
<a name="l00568"></a>00568                         <span class="keywordflow">if</span> _tag.upper() == <span class="stringliteral">&#39;HUSB&#39;</span>:
<a name="l00569"></a>00569                             _husb =  linelist[2][1:-1]
<a name="l00570"></a>00570                         <span class="keywordflow">elif</span> _tag.upper() == <span class="stringliteral">&#39;WIFE&#39;</span>:
<a name="l00571"></a>00571                             _wife =  linelist[2][1:-1]
<a name="l00572"></a>00572                         <span class="keywordflow">elif</span> _tag.upper() == <span class="stringliteral">&#39;CHIL&#39;</span>:
<a name="l00573"></a>00573                             _child.append(linelist[2][1:-1])
<a name="l00574"></a>00574                         <span class="keywordflow">else</span>:
<a name="l00575"></a>00575                             <span class="keywordflow">if</span> messages == <span class="stringliteral">&#39;debug&#39;</span>:
<a name="l00576"></a>00576                                 <span class="keywordflow">print</span> <span class="stringliteral">&#39;Skipping unknown tag %s&#39;</span> % ( _tag )
<a name="l00577"></a>00577                     <span class="keywordflow">if</span> c == len(_curr_rec)-1:
<a name="l00578"></a>00578                         <span class="keywordflow">if</span> _husb:
<a name="l00579"></a>00579                             fam2husb[_fam] = _husb
<a name="l00580"></a>00580                         <span class="keywordflow">if</span> _wife:
<a name="l00581"></a>00581                             fam2wife[_fam] = _wife
<a name="l00582"></a>00582                         <span class="keywordflow">if</span> _child:
<a name="l00583"></a>00583                             <span class="keywordflow">for</span> _ch <span class="keywordflow">in</span> _child:
<a name="l00584"></a>00584                                 fam2chil[_fam] = {}
<a name="l00585"></a>00585                                 fam2chil[_fam][_ch] = _ch
<a name="l00586"></a>00586 
<a name="l00587"></a>00587         <span class="keywordflow">if</span> debug:
<a name="l00588"></a>00588             <span class="keywordflow">print</span> <span class="stringliteral">&#39;indi2sex: &#39;</span>, indi2sex
<a name="l00589"></a>00589             <span class="keywordflow">print</span> <span class="stringliteral">&#39;indi2birth: &#39;</span>, indi2birth
<a name="l00590"></a>00590             <span class="keywordflow">print</span> <span class="stringliteral">&#39;indi2name: &#39;</span>, indi2name
<a name="l00591"></a>00591             <span class="keywordflow">print</span> <span class="stringliteral">&#39;indi2famc: &#39;</span>, indi2famc
<a name="l00592"></a>00592             <span class="keywordflow">print</span> <span class="stringliteral">&#39;indi2fams: &#39;</span>, indi2fams
<a name="l00593"></a>00593             <span class="keywordflow">print</span> <span class="stringliteral">&#39;fam2husb: &#39;</span>, fam2husb
<a name="l00594"></a>00594             <span class="keywordflow">print</span> <span class="stringliteral">&#39;fam2wife: &#39;</span>, fam2wife
<a name="l00595"></a>00595 
<a name="l00596"></a>00596         <span class="comment"># Now we walk through the INDI records and assemble everything. Note</span>
<a name="l00597"></a>00597         <span class="comment"># that there is no error-checking here. I don&#39;t want to have error-</span>
<a name="l00598"></a>00598         <span class="comment"># checking code in two different places, namely here and in the</span>
<a name="l00599"></a>00599         <span class="comment"># NewPedigree::preprocess() method. Therefore, all error-checking is</span>
<a name="l00600"></a>00600         <span class="comment"># deferred to the class method.</span>
<a name="l00601"></a>00601         assembled = {}
<a name="l00602"></a>00602         <span class="keywordflow">for</span> i <span class="keywordflow">in</span> indi2sex.keys():
<a name="l00603"></a>00603             assembled[i] = {}
<a name="l00604"></a>00604             assembled[i][<span class="stringliteral">&#39;indi&#39;</span>] = i
<a name="l00605"></a>00605             assembled[i][<span class="stringliteral">&#39;sex&#39;</span>] = indi2sex[i]
<a name="l00606"></a>00606             assembled[i][<span class="stringliteral">&#39;birth&#39;</span>] = indi2birth[i]
<a name="l00607"></a>00607             assembled[i][<span class="stringliteral">&#39;name&#39;</span>] = indi2name[i]
<a name="l00608"></a>00608             <span class="keywordflow">try</span>:
<a name="l00609"></a>00609                 assembled[i][<span class="stringliteral">&#39;sire&#39;</span>] = fam2husb[indi2famc[i]]
<a name="l00610"></a>00610             <span class="keywordflow">except</span> KeyError:
<a name="l00611"></a>00611                 assembled[i][<span class="stringliteral">&#39;sire&#39;</span>] = missing_parent
<a name="l00612"></a>00612             <span class="keywordflow">try</span>:
<a name="l00613"></a>00613                 assembled[i][<span class="stringliteral">&#39;dam&#39;</span>] = fam2wife[indi2famc[i]]
<a name="l00614"></a>00614             <span class="keywordflow">except</span> KeyError:
<a name="l00615"></a>00615                 assembled[i][<span class="stringliteral">&#39;dam&#39;</span>] = missing_parent
<a name="l00616"></a>00616         <span class="keywordflow">if</span> debug:
<a name="l00617"></a>00617             <span class="keywordflow">print</span> <span class="stringliteral">&#39;assembled: &#39;</span>, assembled
<a name="l00618"></a>00618         <span class="keywordflow">if</span> messages == <span class="stringliteral">&#39;verbose&#39;</span>:
<a name="l00619"></a>00619             <span class="keywordflow">print</span> <span class="stringliteral">&#39;[INFO]: Successfully imported pedigree from the GEDCOM file %s!&#39;</span> \
<a name="l00620"></a>00620                 % ( infilename )
<a name="l00621"></a>00621         logging.info(<span class="stringliteral">&#39;Successfully imported pedigree from the GEDCOM file %s!&#39;</span>,infilename)
<a name="l00622"></a>00622     <span class="keywordflow">except</span>:
<a name="l00623"></a>00623         <span class="keywordflow">if</span> messages == <span class="stringliteral">&#39;verbose&#39;</span>:
<a name="l00624"></a>00624             <span class="keywordflow">print</span> <span class="stringliteral">&#39;[ERROR]: Unable to import pedigree from the GEDCOM file %s!&#39;</span> \
<a name="l00625"></a>00625                 % ( infilename )
<a name="l00626"></a>00626         logging.error(<span class="stringliteral">&#39;Unable to import pedigree from the GEDCOM file %s!&#39;</span>,infilename)
<a name="l00627"></a>00627 
<a name="l00628"></a>00628     <span class="comment"># Save the GEDCOM file in ASD format and update the</span>
<a name="l00629"></a>00629     <span class="comment"># the value of pedfile.</span>
<a name="l00630"></a>00630     <span class="keywordflow">try</span>:
<a name="l00631"></a>00631         outfilename = <span class="stringliteral">&#39;%s.tmp&#39;</span> % ( infilename )
<a name="l00632"></a>00632         pedformat = save_from_gedcom(outfilename,assembled)
<a name="l00633"></a>00633     <span class="keywordflow">except</span>:
<a name="l00634"></a>00634         pedformat = <span class="stringliteral">&#39;xxxx&#39;</span>
<a name="l00635"></a>00635     <span class="keywordflow">return</span> pedformat
<a name="l00636"></a>00636 
<a name="l00637"></a>00637 <span class="comment">##</span>
<a name="l00638"></a>00638 <span class="comment"># save_from_gedcom() takes pedigree data parsed by load_from_gedcom() and</span>
<a name="l00639"></a>00639 <span class="comment"># writes it to a text file in an ASD format that PyPedal can easily read.</span>
<a name="l00640"></a>00640 <span class="comment"># @param outfilename The file to which the records should be written.</span>
<a name="l00641"></a>00641 <span class="comment"># @param assembled A list of records read from a GEDCOM input file</span>
<a name="l00642"></a>00642 <span class="comment"># @retval A string containing the pedigree format code. &#39;xxxx&#39; if there was a problem.</span>
<a name="l00643"></a>00643 <span class="keyword">def </span>save_from_gedcom(outfilename, assembled):
<a name="l00644"></a>00644     <span class="stringliteral">&quot;&quot;&quot;</span>
<a name="l00645"></a>00645 <span class="stringliteral">    save_from_gedcom() takes pedigree data parsed by load_from_gedcom() and</span>
<a name="l00646"></a>00646 <span class="stringliteral">    writes it to a text file in an ASD format that PyPedal can easily read.</span>
<a name="l00647"></a>00647 <span class="stringliteral">    &quot;&quot;&quot;</span>
<a name="l00648"></a>00648     pedformat = <span class="stringliteral">&#39;xxxx&#39;</span>
<a name="l00649"></a>00649     <span class="keywordflow">try</span>:
<a name="l00650"></a>00650         ofh = file(outfilename,<span class="stringliteral">&#39;w&#39;</span>)
<a name="l00651"></a>00651         <span class="keywordflow">for</span> _i <span class="keywordflow">in</span> assembled.keys():
<a name="l00652"></a>00652             pedformat = <span class="stringliteral">&#39;ASDxbu&#39;</span>
<a name="l00653"></a>00653             outstring = <span class="stringliteral">&#39;%s,%s,%s,%s,%s,%s\n&#39;</span> % ( \
<a name="l00654"></a>00654                 assembled[_i][<span class="stringliteral">&#39;indi&#39;</span>], \
<a name="l00655"></a>00655                 assembled[_i][<span class="stringliteral">&#39;sire&#39;</span>], \
<a name="l00656"></a>00656                 assembled[_i][<span class="stringliteral">&#39;dam&#39;</span>], \
<a name="l00657"></a>00657                 assembled[_i][<span class="stringliteral">&#39;sex&#39;</span>], \
<a name="l00658"></a>00658                 assembled[_i][<span class="stringliteral">&#39;birth&#39;</span>], \
<a name="l00659"></a>00659                 assembled[_i][<span class="stringliteral">&#39;name&#39;</span>], \
<a name="l00660"></a>00660             )
<a name="l00661"></a>00661             ofh.write(outstring)
<a name="l00662"></a>00662         ofh.close()
<a name="l00663"></a>00663         logging.info(<span class="stringliteral">&#39;Saved GEDCOM pedigree to the file %s!&#39;</span>,outfilename)
<a name="l00664"></a>00664     <span class="keywordflow">except</span>:
<a name="l00665"></a>00665         logging.error(<span class="stringliteral">&#39;Unable to save GEDCOM pedigree to the file %s!&#39;</span>,outfilename)
<a name="l00666"></a>00666     <span class="keywordflow">return</span> pedformat
<a name="l00667"></a>00667 
<a name="l00668"></a>00668 <span class="comment">##</span>
<a name="l00669"></a>00669 <span class="comment"># save_to_gedcom() writes a PyPedal NewPedigree object to a file in</span>
<a name="l00670"></a>00670 <span class="comment"># GEDCOM 5.5 format.</span>
<a name="l00671"></a>00671 <span class="comment"># @param pedobj An instance of a PyPedal NewPedigree object</span>
<a name="l00672"></a>00672 <span class="comment"># @param outfilename The file to which the matrix should be written</span>
<a name="l00673"></a>00673 <span class="comment"># @retval A save status indicator (0: failed, 1: success).</span>
<a name="l00674"></a>00674 <span class="keyword">def </span>save_to_gedcom(pedobj, outfilename):
<a name="l00675"></a>00675     <span class="stringliteral">&quot;&quot;&quot;</span>
<a name="l00676"></a>00676 <span class="stringliteral">    save_to_gedcom() writes a PyPedal NewPedigree object to a file in</span>
<a name="l00677"></a>00677 <span class="stringliteral">    GEDCOM 5.5 format.</span>
<a name="l00678"></a>00678 <span class="stringliteral">    &quot;&quot;&quot;</span>
<a name="l00679"></a>00679     <span class="keywordflow">try</span>:
<a name="l00680"></a>00680         ofh = file(outfilename,<span class="stringliteral">&#39;w&#39;</span>)
<a name="l00681"></a>00681         <span class="comment"># Write file header</span>
<a name="l00682"></a>00682         ofh.write(<span class="stringliteral">&#39;0 HEAD\n&#39;</span>)
<a name="l00683"></a>00683         ofh.write(<span class="stringliteral">&#39;1 SOUR PYPEDAL\n&#39;</span>)
<a name="l00684"></a>00684         ofh.write(<span class="stringliteral">&#39;2 VERS V2.0\n&#39;</span>)
<a name="l00685"></a>00685         ofh.write(<span class="stringliteral">&#39;2 CORP USDA-ARS-BA-ANRI-AIPL\n&#39;</span>)
<a name="l00686"></a>00686         ofh.write(<span class="stringliteral">&#39;1 DEST PYPEDAL\n&#39;</span>)
<a name="l00687"></a>00687         ofh.write(<span class="stringliteral">&#39;1 DATE %s\n&#39;</span> % (time.strftime(<span class="stringliteral">&#39;%m %d %Y&#39;</span>, \
<a name="l00688"></a>00688             (time.localtime(time.time())))) )
<a name="l00689"></a>00689         ofh.write(<span class="stringliteral">&#39;1 FILE %s\n&#39;</span> % (pedobj.kw[<span class="stringliteral">&#39;pedfile&#39;</span>]) )
<a name="l00690"></a>00690         ofh.write(<span class="stringliteral">&#39;1 GEDC\n&#39;</span>)
<a name="l00691"></a>00691         ofh.write(<span class="stringliteral">&#39;2 VERS 5.5\n&#39;</span>)
<a name="l00692"></a>00692         ofh.write(<span class="stringliteral">&#39;2 FORM Lineage-Linked\n&#39;</span>)
<a name="l00693"></a>00693         ofh.write(<span class="stringliteral">&#39;1 CHAR ASCII\n&#39;</span>)
<a name="l00694"></a>00694         <span class="comment"># Fill the file</span>
<a name="l00695"></a>00695         indi = {}
<a name="l00696"></a>00696         fam = {}
<a name="l00697"></a>00697         par2spouses = {}
<a name="l00698"></a>00698         <span class="comment"># Sweep the pedigree once to find allnon-founders and map the founders</span>
<a name="l00699"></a>00699         <span class="comment"># to families so that we can correctly assign FAMS tags to founder records.</span>
<a name="l00700"></a>00700         <span class="keywordflow">for</span> p <span class="keywordflow">in</span> pedobj.pedigree:
<a name="l00701"></a>00701             <span class="keywordflow">if</span> p.sireID != pedobj.kw[<span class="stringliteral">&#39;missing_parent&#39;</span>] <span class="keywordflow">or</span> p.damID != pedobj.kw[<span class="stringliteral">&#39;missing_parent&#39;</span>]:
<a name="l00702"></a>00702                 <span class="keywordflow">if</span> <span class="keywordflow">not</span> par2spouses.has_key(p.sireID):
<a name="l00703"></a>00703                     par2spouses[p.sireID] = []
<a name="l00704"></a>00704                 <span class="keywordflow">if</span> <span class="keywordflow">not</span> par2spouses.has_key(p.damID):
<a name="l00705"></a>00705                     par2spouses[p.damID] = []
<a name="l00706"></a>00706                 <span class="keywordflow">if</span> p.sireName == pedobj.kw[<span class="stringliteral">&#39;missing_name&#39;</span>] <span class="keywordflow">and</span> p.damName == pedobj.kw[<span class="stringliteral">&#39;missing_name&#39;</span>]:
<a name="l00707"></a>00707                     _spouses = <span class="stringliteral">&#39;F0_0&#39;</span>
<a name="l00708"></a>00708                     <span class="keywordflow">if</span> p.sireID != pedobj.kw[<span class="stringliteral">&#39;missing_parent&#39;</span>]:
<a name="l00709"></a>00709                         <span class="keywordflow">if</span> _spouses <span class="keywordflow">not</span> <span class="keywordflow">in</span> par2spouses[p.sireID]:
<a name="l00710"></a>00710                             par2spouses[p.sireID].append(_spouses)
<a name="l00711"></a>00711                     <span class="keywordflow">if</span> p.damID != pedobj.kw[<span class="stringliteral">&#39;missing_parent&#39;</span>]:
<a name="l00712"></a>00712                         <span class="keywordflow">if</span> _spouses <span class="keywordflow">not</span> <span class="keywordflow">in</span> par2spouses[p.damID]:
<a name="l00713"></a>00713                             par2spouses[p.damID].append(_spouses)
<a name="l00714"></a>00714                 <span class="keywordflow">elif</span> p.sireName == pedobj.kw[<span class="stringliteral">&#39;missing_name&#39;</span>]:
<a name="l00715"></a>00715                     _spouses = <span class="stringliteral">&#39;F%s&#39;</span> % ( p.damName )
<a name="l00716"></a>00716                     <span class="keywordflow">if</span> p.damID != pedobj.kw[<span class="stringliteral">&#39;missing_parent&#39;</span>]:
<a name="l00717"></a>00717                         <span class="keywordflow">if</span> _spouses <span class="keywordflow">not</span> <span class="keywordflow">in</span> par2spouses[p.damID]:
<a name="l00718"></a>00718                             par2spouses[p.damID].append(_spouses)
<a name="l00719"></a>00719                 <span class="keywordflow">elif</span> p.damName == pedobj.kw[<span class="stringliteral">&#39;missing_name&#39;</span>]:
<a name="l00720"></a>00720                     _spouses = <span class="stringliteral">&#39;F%s&#39;</span> % ( p.sireName )
<a name="l00721"></a>00721                     <span class="keywordflow">if</span> p.sireID != pedobj.kw[<span class="stringliteral">&#39;missing_parent&#39;</span>]:
<a name="l00722"></a>00722                         <span class="keywordflow">if</span> _spouses <span class="keywordflow">not</span> <span class="keywordflow">in</span> par2spouses[p.sireID]:
<a name="l00723"></a>00723                             par2spouses[p.sireID].append(_spouses)
<a name="l00724"></a>00724                 <span class="keywordflow">else</span>:
<a name="l00725"></a>00725                     _spouses = <span class="stringliteral">&#39;F%s_%s&#39;</span> % ( p.sireName, p.damName )
<a name="l00726"></a>00726                     <span class="keywordflow">if</span> p.sireID != pedobj.kw[<span class="stringliteral">&#39;missing_parent&#39;</span>]:
<a name="l00727"></a>00727                         <span class="keywordflow">if</span> _spouses <span class="keywordflow">not</span> <span class="keywordflow">in</span> par2spouses[p.sireID]:
<a name="l00728"></a>00728                             par2spouses[p.sireID].append(_spouses)
<a name="l00729"></a>00729                     <span class="keywordflow">if</span> p.damID != pedobj.kw[<span class="stringliteral">&#39;missing_parent&#39;</span>]:
<a name="l00730"></a>00730                         <span class="keywordflow">if</span> _spouses <span class="keywordflow">not</span> <span class="keywordflow">in</span> par2spouses[p.damID]:
<a name="l00731"></a>00731                             par2spouses[p.damID].append(_spouses)
<a name="l00732"></a>00732         <span class="comment"># Create INDI and FAM records for each animal in the pedigree.</span>
<a name="l00733"></a>00733         <span class="keywordflow">for</span> p <span class="keywordflow">in</span> pedobj.pedigree:
<a name="l00734"></a>00734             <span class="keywordflow">if</span> p.sireName == pedobj.kw[<span class="stringliteral">&#39;missing_name&#39;</span>] <span class="keywordflow">and</span> p.damName == pedobj.kw[<span class="stringliteral">&#39;missing_name&#39;</span>]:
<a name="l00735"></a>00735                 _fam = <span class="stringliteral">&#39;F0_0&#39;</span>
<a name="l00736"></a>00736             <span class="keywordflow">elif</span> p.sireName == pedobj.kw[<span class="stringliteral">&#39;missing_name&#39;</span>]:
<a name="l00737"></a>00737                 _fam = <span class="stringliteral">&#39;F%s&#39;</span> % ( p.damName )
<a name="l00738"></a>00738             <span class="keywordflow">elif</span> p.damName == pedobj.kw[<span class="stringliteral">&#39;missing_name&#39;</span>]:
<a name="l00739"></a>00739                 _fam = <span class="stringliteral">&#39;F%s&#39;</span> % ( p.sireName )
<a name="l00740"></a>00740             <span class="keywordflow">else</span>:
<a name="l00741"></a>00741                 _fam = <span class="stringliteral">&#39;F%s_%s&#39;</span> % ( p.sireName, p.damName )
<a name="l00742"></a>00742             <span class="keywordflow">if</span> <span class="keywordflow">not</span> indi.has_key(p.animalID):
<a name="l00743"></a>00743                 indi[p.animalID] = <span class="stringliteral">&#39;0 @%s@ INDI\n&#39;</span> % \
<a name="l00744"></a>00744                     ( pedobj.namebackmap[pedobj.backmap[p.animalID]] )
<a name="l00745"></a>00745                 indi[p.animalID] = <span class="stringliteral">&#39;%s1 SEX %s\n&#39;</span> % ( indi[p.animalID], p.sex.upper() )
<a name="l00746"></a>00746                 <span class="keywordflow">if</span> <span class="stringliteral">&#39;n&#39;</span> <span class="keywordflow">in</span> pedobj.kw[<span class="stringliteral">&#39;pedformat&#39;</span>]:
<a name="l00747"></a>00747                     indi[p.animalID] = <span class="stringliteral">&#39;%s1 NAME %s\n&#39;</span> % ( indi[p.animalID], p.name )
<a name="l00748"></a>00748                 <span class="keywordflow">elif</span> <span class="stringliteral">&#39;</span><span class="stringliteral">u&#39; in pedobj.kw[&#39;</span>pedformat&#39;]:
<a name="l00749"></a>00749                     indi[p.animalID] = <span class="stringliteral">&#39;%s1 NAME %s\n&#39;</span> % ( indi[p.animalID], p.userField )
<a name="l00750"></a>00750                 <span class="keywordflow">else</span>:
<a name="l00751"></a>00751                     <span class="keywordflow">pass</span>
<a name="l00752"></a>00752                 <span class="keywordflow">if</span> <span class="stringliteral">&#39;y&#39;</span> <span class="keywordflow">in</span> pedobj.kw[<span class="stringliteral">&#39;pedformat&#39;</span>] <span class="keywordflow">and</span> p.by != pedobj.kw[<span class="stringliteral">&#39;missing_byear&#39;</span>]:
<a name="l00753"></a>00753                     indi[p.animalID] = <span class="stringliteral">&#39;%s1 BIRT\n&#39;</span> % ( indi[p.animalID] )
<a name="l00754"></a>00754                     indi[p.animalID] = <span class="stringliteral">&#39;%s2 DATE %s\n&#39;</span> % ( indi[p.animalID], p.by )
<a name="l00755"></a>00755                 <span class="keywordflow">if</span> <span class="stringliteral">&#39;b&#39;</span> <span class="keywordflow">in</span> pedobj.kw[<span class="stringliteral">&#39;pedformat&#39;</span>] <span class="keywordflow">and</span> ( p.bd != pedobj.kw[<span class="stringliteral">&#39;missing_bdate&#39;</span>] <span class="keywordflow">and</span> p.bd != str(pedobj.kw[<span class="stringliteral">&#39;missing_byear&#39;</span>]) ):
<a name="l00756"></a>00756                     indi[p.animalID] = <span class="stringliteral">&#39;%s1 BIRT\n&#39;</span> % ( indi[p.animalID] )
<a name="l00757"></a>00757                     indi[p.animalID] = <span class="stringliteral">&#39;%s2 DATE %s\n&#39;</span> % ( indi[p.animalID], p.bd )
<a name="l00758"></a>00758                 <span class="keywordflow">if</span> _fam != <span class="stringliteral">&#39;F0_0&#39;</span>:
<a name="l00759"></a>00759                     indi[p.animalID] = <span class="stringliteral">&#39;%s1 FAMC @%s@\n&#39;</span> % ( indi[p.animalID], _fam )
<a name="l00760"></a>00760                 <span class="keywordflow">if</span> par2spouses.has_key(p.animalID):
<a name="l00761"></a>00761                     <span class="keywordflow">for</span> _p2s <span class="keywordflow">in</span> par2spouses[p.animalID]:
<a name="l00762"></a>00762                         <span class="keywordflow">if</span> _p2s != <span class="stringliteral">&#39;F0_0&#39;</span>:
<a name="l00763"></a>00763                             indi[p.animalID] = <span class="stringliteral">&#39;%s1 FAMS @F%s@\n&#39;</span> % ( indi[p.animalID], _p2s )
<a name="l00764"></a>00764             <span class="comment"># Create the family if it does not yet exist</span>
<a name="l00765"></a>00765             <span class="keywordflow">if</span> <span class="keywordflow">not</span> fam.has_key(_fam) <span class="keywordflow">and</span> _fam[3:7] != <span class="stringliteral">&#39;F0_0&#39;</span>:
<a name="l00766"></a>00766                 fam[_fam] = <span class="stringliteral">&#39;0 @%s@ FAM\n&#39;</span> % ( _fam )
<a name="l00767"></a>00767             <span class="keywordflow">if</span> <span class="stringliteral">&#39;HUSB&#39;</span> <span class="keywordflow">not</span> <span class="keywordflow">in</span> fam[_fam] <span class="keywordflow">and</span> p.sireName != pedobj.kw[<span class="stringliteral">&#39;missing_name&#39;</span>]:
<a name="l00768"></a>00768                 fam[_fam] = <span class="stringliteral">&#39;%s1 HUSB @%s@\n&#39;</span> % ( fam[_fam],p.sireName )
<a name="l00769"></a>00769             <span class="keywordflow">if</span> <span class="stringliteral">&#39;WIFE&#39;</span> <span class="keywordflow">not</span> <span class="keywordflow">in</span> fam[_fam] <span class="keywordflow">and</span> p.damName != pedobj.kw[<span class="stringliteral">&#39;missing_name&#39;</span>]:
<a name="l00770"></a>00770                 fam[_fam] = <span class="stringliteral">&#39;%s1 WIFE @%s@\n&#39;</span> % ( fam[_fam], p.damName )
<a name="l00771"></a>00771             fam[_fam] = <span class="stringliteral">&#39;%s1 CHIL @%s@\n&#39;</span> % ( fam[_fam], \
<a name="l00772"></a>00772                 pedobj.namebackmap[pedobj.backmap[p.animalID]] )
<a name="l00773"></a>00773             <span class="comment">#print fam[_fam]</span>
<a name="l00774"></a>00774         <span class="comment"># Now loop and write the contents of indi and fam to the file.</span>
<a name="l00775"></a>00775         <span class="keywordflow">for</span> i <span class="keywordflow">in</span> indi.values():
<a name="l00776"></a>00776             ofh.write(i)
<a name="l00777"></a>00777         <span class="keywordflow">for</span> f <span class="keywordflow">in</span> fam.values():
<a name="l00778"></a>00778             ofh.write(f)
<a name="l00779"></a>00779         <span class="comment"># Write footer and close file</span>
<a name="l00780"></a>00780         ofh.write(<span class="stringliteral">&#39;0 TRLR\n&#39;</span>)
<a name="l00781"></a>00781         ofh.close()
<a name="l00782"></a>00782         <span class="keywordflow">if</span> pedobj.kw[<span class="stringliteral">&#39;messages&#39;</span>] == <span class="stringliteral">&#39;verbose&#39;</span>:
<a name="l00783"></a>00783             <span class="keywordflow">print</span> <span class="stringliteral">&#39;[INFO]: Successfully exported pedigree to the GEDCOM file %s!&#39;</span> \
<a name="l00784"></a>00784                 % ( outfilename )
<a name="l00785"></a>00785         logging.info(<span class="stringliteral">&#39;Successfully exported pedigree to the GEDCOM file %s!&#39;</span>,outfilename)
<a name="l00786"></a>00786         <span class="keywordflow">return</span> 1
<a name="l00787"></a>00787     <span class="keywordflow">except</span>:
<a name="l00788"></a>00788         <span class="keywordflow">if</span> pedobj.kw[<span class="stringliteral">&#39;messages&#39;</span>] == <span class="stringliteral">&#39;verbose&#39;</span>:
<a name="l00789"></a>00789             <span class="keywordflow">print</span> <span class="stringliteral">&#39;[ERROR]: Unable to save pedigree to the GEDCOM file %s!&#39;</span> \
<a name="l00790"></a>00790                 % ( outfilename )
<a name="l00791"></a>00791         logging.error(<span class="stringliteral">&#39;Unable to export pedigree to the GEDCOM file %s!&#39;</span>,outfilename)
<a name="l00792"></a>00792         <span class="keywordflow">return</span> 0
<a name="l00793"></a>00793 
<a name="l00794"></a>00794 <span class="comment">##</span>
<a name="l00795"></a>00795 <span class="comment"># load_from_genes() reads and parses pedigree data that conforms to</span>
<a name="l00796"></a>00796 <span class="comment"># the DBF format used by GENES software for pedigree management v1.2</span>
<a name="l00797"></a>00797 <span class="comment"># (R. Lacey, http://www.vortex9.org/genes.html). When possible data</span>
<a name="l00798"></a>00798 <span class="comment"># are mapped into similar PyPedal fields.</span>
<a name="l00799"></a>00799 <span class="comment"># @param infilename The file from which the pedigree should be read.</span>
<a name="l00800"></a>00800 <span class="comment"># @param messages Controls output to the screen</span>
<a name="l00801"></a>00801 <span class="comment"># @param standalone Uses logging if called by a NewPedigree method</span>
<a name="l00802"></a>00802 <span class="comment"># @param missing_sex Value assigned to an animal with unknown sex</span>
<a name="l00803"></a>00803 <span class="comment"># @param missing_parent Value assigned to unknown parents</span>
<a name="l00804"></a>00804 <span class="comment"># @param missing_name Name assigned by default</span>
<a name="l00805"></a>00805 <span class="comment"># @param missing_bdate Value assigned to unknown birthdates</span>
<a name="l00806"></a>00806 <span class="comment"># @param debug Flag turning debugging messages on (1) and off (0)</span>
<a name="l00807"></a>00807 <span class="comment"># @retval A save status indicator (0: failed, 1: success).</span>
<a name="l00808"></a>00808 <span class="keyword">def </span>load_from_genes(infilename, messages=&#39;verbose&#39;, standalone=1, missing_sex=&#39;u&#39;, \
<a name="l00809"></a>00809     missing_parent=0, missing_name=<span class="stringliteral">&#39;Unknown Name&#39;</span>, missing_bdate=<span class="stringliteral">&#39;01011900&#39;</span>, debug=0):
<a name="l00810"></a>00810     <span class="stringliteral">&quot;&quot;&quot;</span>
<a name="l00811"></a>00811 <span class="stringliteral">    load_from_genes() reads and parses pedigree data from the dBase III</span>
<a name="l00812"></a>00812 <span class="stringliteral">    files used by GENES 1.20 (http://www.vortex9.org/genes.html).</span>
<a name="l00813"></a>00813 <span class="stringliteral">    &quot;&quot;&quot;</span>
<a name="l00814"></a>00814 
<a name="l00815"></a>00815     <span class="keyword">import</span> struct, datetime, decimal, itertools
<a name="l00816"></a>00816 
<a name="l00817"></a>00817     record_list = []
<a name="l00818"></a>00818     f = open(infilename, <span class="stringliteral">&#39;rb&#39;</span>)
<a name="l00819"></a>00819 
<a name="l00820"></a>00820     <span class="comment">### Begin code of Raymond Hettinger&#39;s taken from http://code.activestate.com/recipes/362715/</span>
<a name="l00821"></a>00821     <span class="comment">### and modified slightly for PyPedal.</span>
<a name="l00822"></a>00822     <span class="comment"># fields is list of field names and field specs: (type, size, decimal places).</span>
<a name="l00823"></a>00823     <span class="comment"># record_list contains data records.</span>
<a name="l00824"></a>00824     <span class="comment"># If a record is marked as deleted, it is skipped.</span>
<a name="l00825"></a>00825     <span class="comment">#</span>
<a name="l00826"></a>00826     <span class="comment"># File should be opened for binary reads.</span>
<a name="l00827"></a>00827     numrec, lenheader = struct.unpack(<span class="stringliteral">&#39;&lt;xxxxLH22x&#39;</span>, f.read(32))
<a name="l00828"></a>00828     numfields = (lenheader - 33) // 32
<a name="l00829"></a>00829     fields = []
<a name="l00830"></a>00830     <span class="keywordflow">for</span> fieldno <span class="keywordflow">in</span> xrange(numfields):
<a name="l00831"></a>00831         name, typ, size, deci = struct.unpack(<span class="stringliteral">&#39;&lt;11sc4xBB14x&#39;</span>, f.read(32))
<a name="l00832"></a>00832         name = name.replace(<span class="stringliteral">&#39;\0&#39;</span>, <span class="stringliteral">&#39;&#39;</span>)       <span class="comment"># eliminate NULs from string</span>
<a name="l00833"></a>00833         fields.append((name, typ, size, deci))
<a name="l00834"></a>00834     <span class="comment">#yield [field[0] for field in fields]</span>
<a name="l00835"></a>00835     <span class="comment">#print fields</span>
<a name="l00836"></a>00836     <span class="comment">#if debug:</span>
<a name="l00837"></a>00837     <span class="comment">#    print [field[0] for field in fields]</span>
<a name="l00838"></a>00838     <span class="comment">#yield [tuple(field[1:]) for field in fields]</span>
<a name="l00839"></a>00839     <span class="comment">#if debug:</span>
<a name="l00840"></a>00840     <span class="comment">#    print [tuple(field[1:]) for field in fields]</span>
<a name="l00841"></a>00841     terminator = f.read(1)
<a name="l00842"></a>00842     <span class="keyword">assert</span> terminator == <span class="stringliteral">&#39;\r&#39;</span>
<a name="l00843"></a>00843     fields.insert(0, (<span class="stringliteral">&#39;DeletionFlag&#39;</span>, <span class="stringliteral">&#39;C&#39;</span>, 1, 0))
<a name="l00844"></a>00844     fmt = <span class="stringliteral">&#39;&#39;</span>.join([<span class="stringliteral">&#39;%ds&#39;</span> % fieldinfo[2] <span class="keywordflow">for</span> fieldinfo <span class="keywordflow">in</span> fields])
<a name="l00845"></a>00845     fmtsiz = struct.calcsize(fmt)
<a name="l00846"></a>00846     <span class="keywordflow">for</span> i <span class="keywordflow">in</span> xrange(numrec):
<a name="l00847"></a>00847         record = struct.unpack(fmt, f.read(fmtsiz))
<a name="l00848"></a>00848         <span class="keywordflow">if</span> record[0] != <span class="stringliteral">&#39; &#39;</span>:
<a name="l00849"></a>00849             <span class="keywordflow">continue</span>                        <span class="comment"># deleted record</span>
<a name="l00850"></a>00850         result = []
<a name="l00851"></a>00851         <span class="keywordflow">for</span> (name, typ, size, deci), value <span class="keywordflow">in</span> itertools.izip(fields, record):
<a name="l00852"></a>00852             <span class="keywordflow">if</span> name == <span class="stringliteral">&#39;DeletionFlag&#39;</span>:
<a name="l00853"></a>00853                 <span class="keywordflow">continue</span>
<a name="l00854"></a>00854             <span class="keywordflow">if</span> typ == <span class="stringliteral">&quot;N&quot;</span>:
<a name="l00855"></a>00855                 value = value.replace(<span class="stringliteral">&#39;\0&#39;</span>, <span class="stringliteral">&#39;&#39;</span>).lstrip()
<a name="l00856"></a>00856                 <span class="keywordflow">if</span> value == <span class="stringliteral">&#39;&#39;</span>:
<a name="l00857"></a>00857                     value = 0
<a name="l00858"></a>00858                 <span class="keywordflow">elif</span> deci:
<a name="l00859"></a>00859                     value = value.replace(<span class="stringliteral">&#39;\x1a&#39;</span>, <span class="stringliteral">&#39;&#39;</span>).lstrip() <span class="comment"># String ctrl-Z line ending</span>
<a name="l00860"></a>00860                     value = decimal.Decimal(value)
<a name="l00861"></a>00861                     value = float(value)
<a name="l00862"></a>00862                 <span class="keywordflow">else</span>:
<a name="l00863"></a>00863                     value = int(value)
<a name="l00864"></a>00864             <span class="keywordflow">elif</span> typ == <span class="stringliteral">&#39;D&#39;</span>:
<a name="l00865"></a>00865                 y, m, d = value[:4], value[4:6], value[6:8]
<a name="l00866"></a>00866                 value=d+<span class="stringliteral">&quot;/&quot;</span>+m+<span class="stringliteral">&quot;/&quot;</span>+y
<a name="l00867"></a>00867             <span class="keywordflow">elif</span> typ == <span class="stringliteral">&#39;L&#39;</span>:
<a name="l00868"></a>00868                 value = (value <span class="keywordflow">in</span> <span class="stringliteral">&#39;YyTt&#39;</span> <span class="keywordflow">and</span> <span class="stringliteral">&#39;T&#39;</span>) <span class="keywordflow">or</span> (value <span class="keywordflow">in</span> <span class="stringliteral">&#39;NnFf&#39;</span> <span class="keywordflow">and</span> <span class="stringliteral">&#39;F&#39;</span>) <span class="keywordflow">or</span> <span class="stringliteral">&#39;?&#39;</span>
<a name="l00869"></a>00869             <span class="keywordflow">elif</span> typ == <span class="stringliteral">&#39;F&#39;</span>:
<a name="l00870"></a>00870                 value = float(value)
<a name="l00871"></a>00871             result.append(value)
<a name="l00872"></a>00872         record_list.append(result)
<a name="l00873"></a>00873     <span class="comment">### End code of Raymond Hettinger&#39;s taken from http://code.activestate.com/recipes/362715/</span>
<a name="l00874"></a>00874     f.close()
<a name="l00875"></a>00875     <span class="comment"># Check inputs visually</span>
<a name="l00876"></a>00876     <span class="comment">#if debug:</span>
<a name="l00877"></a>00877     <span class="comment">#    for r in record_list:</span>
<a name="l00878"></a>00878     <span class="comment">#        print r</span>
<a name="l00879"></a>00879     <span class="comment">#    print [field[0] for field in fields]</span>
<a name="l00880"></a>00880     <span class="comment"># Here we go...</span>
<a name="l00881"></a>00881     field_list = [field[0] <span class="keywordflow">for</span> field <span class="keywordflow">in</span> fields]
<a name="l00882"></a>00882     assembled = {}
<a name="l00883"></a>00883     <span class="comment"># As is also the case for GEDCOM record processing, no consistency checks are performed in this</span>
<a name="l00884"></a>00884     <span class="comment"># subroutine. The only &quot;edits&quot; made are to insure that values, e.g. sex codes, are consistent with</span>
<a name="l00885"></a>00885     <span class="comment"># the values expected by PyPedal.</span>
<a name="l00886"></a>00886     <span class="keywordflow">for</span> r <span class="keywordflow">in</span> record_list:
<a name="l00887"></a>00887         anidx = field_list.index(<span class="stringliteral">&#39;STUD_ID&#39;</span>) - 1         <span class="comment"># The subtraction deals with the DeletionFlag</span>
<a name="l00888"></a>00888         assembled[r[anidx]] = {}
<a name="l00889"></a>00889         assembled[r[anidx]][<span class="stringliteral">&#39;indi&#39;</span>] = r[anidx].strip()
<a name="l00890"></a>00890         <span class="comment"># Unlike GENES, PyPedal does not distinguish among animals that are known founders and those that</span>
<a name="l00891"></a>00891         <span class="comment"># have unknown parents but are not founders.</span>
<a name="l00892"></a>00892         assembled[r[anidx]][<span class="stringliteral">&#39;sire&#39;</span>] = r[field_list.index(<span class="stringliteral">&#39;SIRE_ID&#39;</span>) - 1].strip()     <span class="comment"># &quot;   UNK&quot; = unknown (&quot;  WILD&quot; = founder)</span>
<a name="l00893"></a>00893         assembled[r[anidx]][<span class="stringliteral">&#39;dam&#39;</span>] = r[field_list.index(<span class="stringliteral">&#39;DAM_ID&#39;</span>) - 1].strip()      <span class="comment"># &quot;   UNK&quot; = unknown (&quot;  WILD&quot; = founder)</span>
<a name="l00894"></a>00894         <span class="keywordflow">if</span> assembled[r[anidx]][<span class="stringliteral">&#39;sire&#39;</span>].strip() == <span class="stringliteral">&#39;UNK&#39;</span>: assembled[r[anidx]][<span class="stringliteral">&#39;sire&#39;</span>] = missing_parent
<a name="l00895"></a>00895         <span class="keywordflow">if</span> assembled[r[anidx]][<span class="stringliteral">&#39;sire&#39;</span>].strip() == <span class="stringliteral">&#39;WILD&#39;</span>: assembled[r[anidx]][<span class="stringliteral">&#39;sire&#39;</span>] = missing_parent
<a name="l00896"></a>00896         <span class="keywordflow">if</span> assembled[r[anidx]][<span class="stringliteral">&#39;dam&#39;</span>].strip() == <span class="stringliteral">&#39;UNK&#39;</span>: assembled[r[anidx]][<span class="stringliteral">&#39;dam&#39;</span>] = missing_parent
<a name="l00897"></a>00897         <span class="keywordflow">if</span> assembled[r[anidx]][<span class="stringliteral">&#39;dam&#39;</span>].strip() == <span class="stringliteral">&#39;WILD&#39;</span>: assembled[r[anidx]][<span class="stringliteral">&#39;dam&#39;</span>] = missing_parent
<a name="l00898"></a>00898         assembled[r[anidx]][<span class="stringliteral">&#39;name&#39;</span>] = r[anidx].strip()
<a name="l00899"></a>00899         <span class="comment"># Sex codes are different</span>
<a name="l00900"></a>00900         assembled[r[anidx]][<span class="stringliteral">&#39;sex&#39;</span>] = r[field_list.index(<span class="stringliteral">&#39;SEX&#39;</span>) - 1]          <span class="comment"># 0 = female, 1 = male</span>
<a name="l00901"></a>00901         <span class="keywordflow">if</span> str(assembled[r[anidx]][<span class="stringliteral">&#39;sex&#39;</span>]) == <span class="stringliteral">&#39;0&#39;</span>: assembled[r[anidx]][<span class="stringliteral">&#39;sex&#39;</span>] = <span class="stringliteral">&#39;f&#39;</span>
<a name="l00902"></a>00902         <span class="keywordflow">elif</span> str(assembled[r[anidx]][<span class="stringliteral">&#39;sex&#39;</span>]) == <span class="stringliteral">&#39;1&#39;</span>: assembled[r[anidx]][<span class="stringliteral">&#39;sex&#39;</span>] = <span class="stringliteral">&#39;m&#39;</span>
<a name="l00903"></a>00903         <span class="keywordflow">else</span>: assembled[r[anidx]][<span class="stringliteral">&#39;sex&#39;</span>] = missing_sex
<a name="l00904"></a>00904         <span class="comment"># Flip alive/dead status</span>
<a name="l00905"></a>00905         assembled[r[anidx]][<span class="stringliteral">&#39;alive&#39;</span>] = r[field_list.index(<span class="stringliteral">&#39;DEAD&#39;</span>) - 1]       <span class="comment"># T/F indicating whether the animal is dead (T = dead)</span>
<a name="l00906"></a>00906         <span class="keywordflow">if</span> assembled[r[anidx]][<span class="stringliteral">&#39;alive&#39;</span>] == <span class="stringliteral">&#39;T&#39;</span>: assembled[r[anidx]][<span class="stringliteral">&#39;alive&#39;</span>] = <span class="stringliteral">&#39;1&#39;</span>
<a name="l00907"></a>00907         <span class="keywordflow">else</span>: assembled[r[anidx]][<span class="stringliteral">&#39;alive&#39;</span>] = <span class="stringliteral">&#39;0&#39;</span>
<a name="l00908"></a>00908         <span class="comment"># Inbreeding</span>
<a name="l00909"></a>00909         assembled[r[anidx]][<span class="stringliteral">&#39;fa&#39;</span>] = r[field_list.index(<span class="stringliteral">&#39;INBREED&#39;</span>) - 1]
<a name="l00910"></a>00910         <span class="comment"># Birthdates can be missing</span>
<a name="l00911"></a>00911         assembled[r[anidx]][<span class="stringliteral">&#39;bd&#39;</span>] = r[field_list.index(<span class="stringliteral">&#39;BDATE&#39;</span>) - 1]
<a name="l00912"></a>00912         pieces = assembled[r[anidx]][<span class="stringliteral">&#39;bd&#39;</span>].split(<span class="stringliteral">&quot;/&quot;</span>)
<a name="l00913"></a>00913         assembled[r[anidx]][<span class="stringliteral">&#39;bd&#39;</span>] = <span class="stringliteral">&#39;%s%s%s&#39;</span> % ( pieces[0], pieces[1], pieces[2] )
<a name="l00914"></a>00914         <span class="keywordflow">if</span> assembled[r[anidx]][<span class="stringliteral">&#39;bd&#39;</span>] == <span class="stringliteral">&#39;&#39;</span>: assembled[r[anidx]][<span class="stringliteral">&#39;bd&#39;</span>] = missing_bdate
<a name="l00915"></a>00915         <span class="comment"># Use herd as a proxy for location</span>
<a name="l00916"></a>00916         assembled[r[anidx]][<span class="stringliteral">&#39;herd&#39;</span>] = r[field_list.index(<span class="stringliteral">&#39;LOCATION&#39;</span>) - 1].strip()
<a name="l00917"></a>00917         <span class="comment"># Age should be okay as-is</span>
<a name="l00918"></a>00918         assembled[r[anidx]][<span class="stringliteral">&#39;age&#39;</span>] = r[field_list.index(<span class="stringliteral">&#39;AGE&#39;</span>) - 1]
<a name="l00919"></a>00919         <span class="comment">#if debug:</span>
<a name="l00920"></a>00920         <span class="comment">#    print assembled[r[anidx]]</span>
<a name="l00921"></a>00921     <span class="keywordflow">if</span> messages == <span class="stringliteral">&#39;verbose&#39;</span>:
<a name="l00922"></a>00922         <span class="keywordflow">print</span> <span class="stringliteral">&#39;[INFO]: Successfully imported pedigree from the GENES 1.20 file %s!&#39;</span> \
<a name="l00923"></a>00923             % ( infilename )
<a name="l00924"></a>00924     logging.info(<span class="stringliteral">&#39;Successfully imported pedigree from the GENES 1.20 file %s!&#39;</span>,infilename)
<a name="l00925"></a>00925 
<a name="l00926"></a>00926     <span class="comment"># Save the GENES file in ASD format and update the</span>
<a name="l00927"></a>00927     <span class="comment"># the value of pedfile.</span>
<a name="l00928"></a>00928     <span class="keywordflow">try</span>:
<a name="l00929"></a>00929         outfilename = <span class="stringliteral">&#39;%s.tmp&#39;</span> % ( infilename )
<a name="l00930"></a>00930         pedformat = save_from_genes(outfilename,assembled)
<a name="l00931"></a>00931     <span class="keywordflow">except</span>:
<a name="l00932"></a>00932         pedformat = <span class="stringliteral">&#39;xxxx&#39;</span>
<a name="l00933"></a>00933     <span class="keywordflow">return</span> pedformat
<a name="l00934"></a>00934 
<a name="l00935"></a>00935 <span class="comment">##</span>
<a name="l00936"></a>00936 <span class="comment"># save_from_genes() takes pedigree data parsed by load_from_genes() and</span>
<a name="l00937"></a>00937 <span class="comment"># writes it to a text file in an ASD format that PyPedal can easily read.</span>
<a name="l00938"></a>00938 <span class="comment"># @param outfilename The file to which the records should be written.</span>
<a name="l00939"></a>00939 <span class="comment"># @param assembled A list of records read from a GENES 1.20 input file</span>
<a name="l00940"></a>00940 <span class="comment"># @retval A string containing the pedigree format code. &#39;xxxx&#39; if there was a problem.</span>
<a name="l00941"></a>00941 <span class="keyword">def </span>save_from_genes(outfilename, assembled):
<a name="l00942"></a>00942     <span class="stringliteral">&quot;&quot;&quot;</span>
<a name="l00943"></a>00943 <span class="stringliteral">    save_from_genes() takes pedigree data parsed by load_from_genes() and</span>
<a name="l00944"></a>00944 <span class="stringliteral">    writes it to a text file in an ASD format that PyPedal can easily read.</span>
<a name="l00945"></a>00945 <span class="stringliteral">    &quot;&quot;&quot;</span>
<a name="l00946"></a>00946     pedformat = <span class="stringliteral">&#39;xxxx&#39;</span>
<a name="l00947"></a>00947     <span class="keywordflow">try</span>:
<a name="l00948"></a>00948         ofh = file(outfilename,<span class="stringliteral">&#39;w&#39;</span>)
<a name="l00949"></a>00949         <span class="keywordflow">for</span> _i <span class="keywordflow">in</span> assembled.keys():
<a name="l00950"></a>00950             pedformat = <span class="stringliteral">&#39;ASDefHlnxy&#39;</span>
<a name="l00951"></a>00951             outstring = <span class="stringliteral">&#39;%s,%s,%s,%s,%s,%s,%s,%s,%s,%s\n&#39;</span> % ( \
<a name="l00952"></a>00952                 assembled[_i][<span class="stringliteral">&#39;indi&#39;</span>], \
<a name="l00953"></a>00953                 assembled[_i][<span class="stringliteral">&#39;sire&#39;</span>], \
<a name="l00954"></a>00954                 assembled[_i][<span class="stringliteral">&#39;dam&#39;</span>], \
<a name="l00955"></a>00955                 assembled[_i][<span class="stringliteral">&#39;age&#39;</span>], \
<a name="l00956"></a>00956                 assembled[_i][<span class="stringliteral">&#39;fa&#39;</span>], \
<a name="l00957"></a>00957                 assembled[_i][<span class="stringliteral">&#39;herd&#39;</span>], \
<a name="l00958"></a>00958                 assembled[_i][<span class="stringliteral">&#39;alive&#39;</span>], \
<a name="l00959"></a>00959                 assembled[_i][<span class="stringliteral">&#39;name&#39;</span>], \
<a name="l00960"></a>00960                 assembled[_i][<span class="stringliteral">&#39;sex&#39;</span>], \
<a name="l00961"></a>00961                 assembled[_i][<span class="stringliteral">&#39;bd&#39;</span>], \
<a name="l00962"></a>00962             )
<a name="l00963"></a>00963             ofh.write(outstring)
<a name="l00964"></a>00964         ofh.close()
<a name="l00965"></a>00965         logging.info(<span class="stringliteral">&#39;Saved GENES 1.20 pedigree to the file %s!&#39;</span>,outfilename)
<a name="l00966"></a>00966     <span class="keywordflow">except</span>:
<a name="l00967"></a>00967         logging.error(<span class="stringliteral">&#39;Unable to save GENES 1.20 pedigree to the file %s!&#39;</span>,outfilename)
<a name="l00968"></a>00968     <span class="keywordflow">return</span> pedformat
<a name="l00969"></a>00969 
<a name="l00970"></a>00970 <span class="comment">##</span>
<a name="l00971"></a>00971 <span class="comment"># save_to_genes() writes a PyPedal NewPedigree object to a file in</span>
<a name="l00972"></a>00972 <span class="comment"># GENES 1.20 (dBase III) format.</span>
<a name="l00973"></a>00973 <span class="comment"># @param pedobj An instance of a PyPedal NewPedigree object</span>
<a name="l00974"></a>00974 <span class="comment"># @param outfilename The file to which the matrix should be written</span>
<a name="l00975"></a>00975 <span class="comment"># @retval A save status indicator (0: failed, 1: success).</span>
<a name="l00976"></a>00976 <span class="keyword">def </span>save_to_genes(pedobj, outfilename):
<a name="l00977"></a>00977     <span class="stringliteral">&quot;&quot;&quot;</span>
<a name="l00978"></a>00978 <span class="stringliteral">    save_to_genes() writes a PyPedal NewPedigree object to a file in</span>
<a name="l00979"></a>00979 <span class="stringliteral">    GENES 1.20 (dBase III) format.</span>
<a name="l00980"></a>00980 <span class="stringliteral">    &quot;&quot;&quot;</span>
<a name="l00981"></a>00981     <span class="keyword">import</span> struct, datetime, decimal, itertools
<a name="l00982"></a>00982 
<a name="l00983"></a>00983     <span class="comment"># These are the field names and data-types per the specification in Lacy&#39;s GENES.DOC.</span>
<a name="l00984"></a>00984     fields = [ (<span class="stringliteral">&#39;STUD_ID&#39;</span>, <span class="stringliteral">&#39;C&#39;</span>, 6, 0), (<span class="stringliteral">&#39;DAM_ID&#39;</span>, <span class="stringliteral">&#39;C&#39;</span>, 6, 0), (<span class="stringliteral">&#39;SIRE_ID&#39;</span>, <span class="stringliteral">&#39;C&#39;</span>, 6, 0), (<span class="stringliteral">&#39;BDATE&#39;</span>, <span class="stringliteral">&#39;D&#39;</span>, 8, 0),
<a name="l00985"></a>00985                (<span class="stringliteral">&#39;SEX&#39;</span>, <span class="stringliteral">&#39;N&#39;</span>, 1, 0), (<span class="stringliteral">&#39;DATEOUT&#39;</span>, <span class="stringliteral">&#39;D&#39;</span>, 8, 0), (<span class="stringliteral">&#39;DEATHDATE&#39;</span>, <span class="stringliteral">&#39;D&#39;</span>, 8, 0), (<span class="stringliteral">&#39;LOCATION&#39;</span>, <span class="stringliteral">&#39;C&#39;</span>, 9, 0),
<a name="l00986"></a>00986                (<span class="stringliteral">&#39;SELECTED&#39;</span>, <span class="stringliteral">&#39;L&#39;</span>, 1, 0), (<span class="stringliteral">&#39;DEAD&#39;</span>, <span class="stringliteral">&#39;L&#39;</span>, 1, 0), (<span class="stringliteral">&#39;INBREED&#39;</span>, <span class="stringliteral">&#39;N&#39;</span>, 8, 4), (<span class="stringliteral">&#39;AGE&#39;</span>, <span class="stringliteral">&#39;N&#39;</span>, 3, 0),
<a name="l00987"></a>00987                (<span class="stringliteral">&#39;KNOWN&#39;</span>, <span class="stringliteral">&#39;N&#39;</span>, 8, 4), (<span class="stringliteral">&#39;INBREED_KN&#39;</span>, <span class="stringliteral">&#39;N&#39;</span>, 8, 4), (<span class="stringliteral">&#39;MK&#39;</span>, <span class="stringliteral">&#39;N&#39;</span>, 8, 4), (<span class="stringliteral">&#39;MK_KN&#39;</span>, <span class="stringliteral">&#39;N&#39;</span>, 8, 4),
<a name="l00988"></a>00988                (<span class="stringliteral">&#39;KV&#39;</span>, <span class="stringliteral">&#39;N&#39;</span>, 8, 4), (<span class="stringliteral">&#39;KV_KN&#39;</span>, <span class="stringliteral">&#39;N&#39;</span>, 8, 4), (<span class="stringliteral">&#39;VX&#39;</span>, <span class="stringliteral">&#39;N&#39;</span>, 8, 4), (<span class="stringliteral">&#39;GU_ALL&#39;</span>, <span class="stringliteral">&#39;N&#39;</span>, 8, 4),
<a name="l00989"></a>00989                (<span class="stringliteral">&#39;GU_DESC&#39;</span>, <span class="stringliteral">&#39;N&#39;</span>, 8, 4), (<span class="stringliteral">&#39;PR_LOST&#39;</span>, <span class="stringliteral">&#39;N&#39;</span>, 8, 4) ]
<a name="l00990"></a>00990 
<a name="l00991"></a>00991     <span class="comment"># Dictionary to map GENES fields to PyPedal NewAnimal attributes</span>
<a name="l00992"></a>00992     pyp2genes = { <span class="stringliteral">&#39;STUD_ID&#39;</span>: <span class="stringliteral">&#39;originalID&#39;</span>, <span class="stringliteral">&#39;SIRE_ID&#39;</span>: <span class="stringliteral">&#39;sireName&#39;</span>, <span class="stringliteral">&#39;DAM_ID&#39;</span>: <span class="stringliteral">&#39;damName&#39;</span>, <span class="stringliteral">&#39;STUD_ID&#39;</span>: <span class="stringliteral">&#39;animalID&#39;</span>, <span class="stringliteral">&#39;BDATE&#39;</span>: <span class="stringliteral">&#39;bd&#39;</span>,
<a name="l00993"></a>00993           <span class="stringliteral">&#39;SEX&#39;</span>: <span class="stringliteral">&#39;sex&#39;</span>, <span class="stringliteral">&#39;LOCATION&#39;</span>: <span class="stringliteral">&#39;originalHerd&#39;</span>, <span class="stringliteral">&#39;DEAD&#39;</span>: <span class="stringliteral">&#39;alive&#39;</span>, <span class="stringliteral">&#39;INBREED&#39;</span>: <span class="stringliteral">&#39;fa&#39;</span>, <span class="stringliteral">&#39;AGE&#39;</span>: <span class="stringliteral">&#39;age&#39;</span>
<a name="l00994"></a>00994     }
<a name="l00995"></a>00995 
<a name="l00996"></a>00996     <span class="comment"># Go ahead and try exporting the pedigree.</span>
<a name="l00997"></a>00997     <span class="keywordflow">try</span>:
<a name="l00998"></a>00998         <span class="comment">### Begin code of Raymond Hettinger&#39;s taken from http://code.activestate.com/recipes/362715/</span>
<a name="l00999"></a>00999         <span class="comment">### and modified slightly for PyPedal.</span>
<a name="l01000"></a>01000         f = open(outfilename, <span class="stringliteral">&#39;wb&#39;</span>)
<a name="l01001"></a>01001         <span class="comment"># Write header info</span>
<a name="l01002"></a>01002         ver = 3
<a name="l01003"></a>01003         now = datetime.datetime.now()
<a name="l01004"></a>01004         yr, mon, day = now.year-1900, now.month, now.day
<a name="l01005"></a>01005         numrec = len(pedobj.pedigree)
<a name="l01006"></a>01006         numfields = len(fields)
<a name="l01007"></a>01007         lenheader = numfields * 32 + 33
<a name="l01008"></a>01008         lenrecord = sum(field[2] <span class="keywordflow">for</span> field <span class="keywordflow">in</span> fields) + 1
<a name="l01009"></a>01009         hdr = struct.pack(<span class="stringliteral">&#39;&lt;BBBBLHH20x&#39;</span>, ver, yr, mon, day, numrec, lenheader, lenrecord)
<a name="l01010"></a>01010         f.write(hdr)
<a name="l01011"></a>01011         <span class="comment"># Write field specs</span>
<a name="l01012"></a>01012         <span class="keywordflow">for</span> fld <span class="keywordflow">in</span> fields:
<a name="l01013"></a>01013             (name, typ, size, deci) = fld
<a name="l01014"></a>01014             name = name.ljust(11, <span class="stringliteral">&#39;\x00&#39;</span>)
<a name="l01015"></a>01015             fld = struct.pack(<span class="stringliteral">&#39;&lt;11sc4xBB14x&#39;</span>, name, typ, size, deci)
<a name="l01016"></a>01016             f.write(fld)
<a name="l01017"></a>01017         <span class="comment"># terminator</span>
<a name="l01018"></a>01018         f.write(<span class="stringliteral">&#39;\r&#39;</span>)
<a name="l01019"></a>01019         <span class="comment"># Write individual records for record in records:</span>
<a name="l01020"></a>01020         <span class="keywordflow">for</span> p <span class="keywordflow">in</span> pedobj.pedigree:
<a name="l01021"></a>01021             f.write(<span class="stringliteral">&#39; &#39;</span>)                        <span class="comment"># deletion flag</span>
<a name="l01022"></a>01022             <span class="keywordflow">for</span> fld <span class="keywordflow">in</span> fields:
<a name="l01023"></a>01023                 (name, typ, size, deci) = fld
<a name="l01024"></a>01024                 <span class="comment"># Assign values or blanks, depending on whether or not PyPedal and GENES information</span>
<a name="l01025"></a>01025                 <span class="comment"># are correspondent.</span>
<a name="l01026"></a>01026                 <span class="keywordflow">if</span> pyp2genes.has_key(name):
<a name="l01027"></a>01027                     value = getattr(p, pyp2genes[name])
<a name="l01028"></a>01028                 <span class="keywordflow">else</span>:
<a name="l01029"></a>01029                     value = <span class="stringliteral">&#39; &#39;</span>
<a name="l01030"></a>01030                 <span class="comment"># We have to do a little re-mapping to deal with, e.g., sex codes.</span>
<a name="l01031"></a>01031                 <span class="keywordflow">if</span> value == pedobj.kw[<span class="stringliteral">&#39;missing_name&#39;</span>]: value = <span class="stringliteral">&#39;   UNK&#39;</span>
<a name="l01032"></a>01032                 <span class="keywordflow">if</span> name == <span class="stringliteral">&#39;SEX&#39;</span>:
<a name="l01033"></a>01033                     <span class="keywordflow">if</span> value == <span class="stringliteral">&#39;f&#39;</span>: value = 0
<a name="l01034"></a>01034                     <span class="keywordflow">elif</span> value == <span class="stringliteral">&#39;m&#39;</span>: value = 1
<a name="l01035"></a>01035                     <span class="keywordflow">else</span>: value = 0                 <span class="comment"># Assume that unknown sex animals are females</span>
<a name="l01036"></a>01036                 <span class="keywordflow">if</span> name == <span class="stringliteral">&#39;DEAD&#39;</span>:
<a name="l01037"></a>01037                     <span class="keywordflow">if</span> value == 0: value = <span class="stringliteral">&#39;T&#39;</span>
<a name="l01038"></a>01038                     <span class="keywordflow">else</span>: value = <span class="stringliteral">&#39;F&#39;</span>
<a name="l01039"></a>01039                 <span class="comment"># Now cast everything and pad out fields to the correct length.</span>
<a name="l01040"></a>01040                 <span class="keywordflow">if</span> typ == <span class="stringliteral">&#39;N&#39;</span>:
<a name="l01041"></a>01041                     value = str(value).rjust(size, <span class="stringliteral">&#39; &#39;</span>)
<a name="l01042"></a>01042                 <span class="keywordflow">elif</span> typ == <span class="stringliteral">&#39;D&#39;</span>:
<a name="l01043"></a>01043                     <span class="keywordflow">if</span> value == <span class="stringliteral">&#39; &#39;</span>:
<a name="l01044"></a>01044                         value = <span class="stringliteral">&#39; &#39;</span>*size
<a name="l01045"></a>01045                     <span class="keywordflow">else</span>:
<a name="l01046"></a>01046                         value = <span class="stringliteral">&#39;%s%s&#39;</span> % ( value[4:8], value[0:4] )
<a name="l01047"></a>01047                 <span class="keywordflow">elif</span> typ == <span class="stringliteral">&#39;L&#39;</span>:
<a name="l01048"></a>01048                     value = str(value)[0].upper()
<a name="l01049"></a>01049                 <span class="keywordflow">else</span>:
<a name="l01050"></a>01050                     <span class="comment"># If we have values that exceed the width of the field truncate them and warn the user.</span>
<a name="l01051"></a>01051                     <span class="keywordflow">if</span> len(str(value)) &gt; size:
<a name="l01052"></a>01052                         value = str(value[0:size+1])
<a name="l01053"></a>01053                         <span class="keywordflow">if</span> messages == <span class="stringliteral">&#39;verbose&#39;</span>:
<a name="l01054"></a>01054                             <span class="keywordflow">print</span> <span class="stringliteral">&#39;[WARNING]: Truncated field %s while exporting to GENES 1.20 file %s!&#39;</span> % ( name, outfilename )
<a name="l01055"></a>01055                         logging.warn(<span class="stringliteral">&#39;Truncated field %s while exporting to GENES 1.20 file %s!&#39;</span>, name, outfilename)
<a name="l01056"></a>01056                     value = str(value)[:size].ljust(size, <span class="stringliteral">&#39; &#39;</span>)
<a name="l01057"></a>01057                 <span class="comment"># Double-check that lengths are correct before writing the record</span>
<a name="l01058"></a>01058                 <span class="keyword">assert</span> len(value) == size
<a name="l01059"></a>01059                 f.write(value)
<a name="l01060"></a>01060         <span class="comment"># End-of-file marker</span>
<a name="l01061"></a>01061         f.write(<span class="stringliteral">&#39;\x1A&#39;</span>)
<a name="l01062"></a>01062         <span class="comment">### End code of Raymond Hettinger&#39;s taken from http://code.activestate.com/recipes/362715/</span>
<a name="l01063"></a>01063         <span class="comment">### and modified slightly for PyPedal.</span>
<a name="l01064"></a>01064         f.close()
<a name="l01065"></a>01065         <span class="keywordflow">if</span> pedobj.kw[<span class="stringliteral">&#39;messages&#39;</span>] == <span class="stringliteral">&#39;verbose&#39;</span>:
<a name="l01066"></a>01066             <span class="keywordflow">print</span> <span class="stringliteral">&#39;[INFO]: Successfully exported pedigree to the GENES file %s!&#39;</span> \
<a name="l01067"></a>01067                 % ( outfilename )
<a name="l01068"></a>01068         logging.info(<span class="stringliteral">&#39;Successfully exported pedigree to the GENES file %s!&#39;</span>,outfilename)
<a name="l01069"></a>01069         <span class="keywordflow">return</span> 1
<a name="l01070"></a>01070     <span class="comment"># If the pedigree could not be exported then tell the user that something went wrong.</span>
<a name="l01071"></a>01071     <span class="keywordflow">except</span>:
<a name="l01072"></a>01072         <span class="keywordflow">if</span> pedobj.kw[<span class="stringliteral">&#39;messages&#39;</span>] == <span class="stringliteral">&#39;verbose&#39;</span>:
<a name="l01073"></a>01073             <span class="keywordflow">print</span> <span class="stringliteral">&#39;[ERROR]: Unable to export pedigree to the GENES file %s!&#39;</span> \
<a name="l01074"></a>01074                 % ( outfilename )
<a name="l01075"></a>01075         logging.error(<span class="stringliteral">&#39;Unable to export pedigree to the GENES file %s!&#39;</span>,outfilename)
<a name="l01076"></a>01076         <span class="keywordflow">return</span> 0
</pre></div></div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Tue May 15 2012 10:09:23 for PyPedal by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.1 </small></address>
</body>
</html>
